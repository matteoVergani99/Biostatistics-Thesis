---
title: "RII"
author: "Matteo Vergani"
date: "`r Sys.Date()`"
output: pdf_document
---

# LIBRARIES AND DIRECTORY  

The libraries required for analysis and the creation of the datasets needed for analysis are downloaded.

\
```{r message=FALSE, warning=FALSE}
# install.packages("stringr")   # If you haven't installed the package yet
library(dplyr) 
library(stringr)
library(readr)
library(labelled)   # labeling data
library(rstatix)    # summary statistics
library(ggpubr)     # convenient summary statistics and plots
library(GGally)     # advanced plot
library(car)        # useful for anova/wald test
library(Epi)        # easy getting CI for model coef/pred
library(lme4)       # linear mixed-effects models
library(lmerTest)   # test for linear mixed-effects models
library(emmeans)    # marginal means
library(multcomp)   # CI for linear combinations of model coef
library(geepack)    # generalized estimating equations
library(ggeffects)  # marginal effects, adjusted predictions
library(gt)         # nice tables
library(msm)        # delta method
library(glm2)

library(tidyverse)  # for everything (data manipulation, visualization, coding, and more)
theme_set(theme_minimal() + theme(legend.position = "bottom")) # theme for ggplot
```
\

The directory is created, pointing to the address where the files containing the datasets are saved.

\
```{r}
directory <- "C:\\Users\\hp\\Documents\\UNIMIB\\Tesi\\Datasets\\"
setwd(directory)
```
\

# DATA

## Complete dataset creation

We download the necessary data to carry out descriptive analyses and implement models.

\
```{r}
load("morti_giorn_comuni.Rdata")
load("reddito.Rdata")
load("istruzione.Rdata")
load("pop_media.Rdata")
```
\

At this point, some preliminary operations are performed, such as sorting the data by municipal identification and time instant and selecting the columns of interest, in order to merge the datasets considered and create the dataset to perform the analysis of our interest.

### Mortality

We sort the mortality data by municipal identifier (`ITTER107`) and time instant (`TIME`).

\
```{r}
morti_giorn_comuni <- morti_giorn_comuni[order(morti_giorn_comuni$ITTER107,morti_giorn_comuni$TIME),]
```
\

### Mid-year resident population 

We sort the data of the average resident population by municipal identifier (`ITTER107`) and time instant (`TIME`).

\
```{r}
pop_media <- pop_media[order(pop_media$ITTER107,pop_media$TIME),]
```
\

### Income

We sort the income data of the Italian population by municipal identifier (`ITTER107`) and time instant (`TIME`). We also select only the columns `ITTER107`, `Territorio`, `TIME`, `INCOME` and `INCOME_RANK`, i.e. those of interest to merge later.

\
```{r}
reddito_merge <- reddito[,c("ITTER107","TIME","INCOME","INCOME_RANK")]
reddito_merge <- reddito_merge[order(reddito_merge$ITTER107,reddito_merge$TIME),]
```
\

### Education

We sort the data on the educational attainment of the Italian population by municipal identifier (`ITTER107`) and time instant (`TIME`). We also select only the columns `ITTER107`, `Territorio`, `TIME`, `EDUC` and `EDUC_RANK`, i.e. those of interest to merge later.

\
```{r}
istruzione_merge <- istruzione[,c("ITTER107","TIME","EDUC","EDUC_RANK")]
istruzione_merge <- istruzione_merge[order(istruzione_merge$ITTER107,istruzione_merge$TIME),]
```
\

## Merge mortality and population

We start by merging the mortality dataset and the average resident population dataset. We perform a *left join* so that we have in the resulting dataset all the observations that are present in the average resident population dataset.

\
```{r}
morti_merge <- morti_giorn_comuni[,c("ITTER107","Territorio","SESSO","CL_ETA","TIME","Decessi")]
pop_merge <- pop_media[,c("ITTER107","Territorio","SESSO","CL_ETA","TIME","pop_media")]
prova <- left_join(pop_merge, morti_merge, by = c("ITTER107", "Territorio", "SESSO", "CL_ETA", "TIME"))
```
\

Let us analyse the distribution of the values assumed by the variables in the `prova` dataset.

\
```{r}
summary(prova)
```
\

The presence of missing values can only be observed in the variable `Decisions` and there are 971232 of them.


To deal with the presence of these missing values, it is decided to assign a value of 0 to the variable `Decessi` in correspondence with the observations that have a missing value for the variable `Decessi`.

\
```{r}
prova$Decessi[is.na(prova$Decessi)] <- 0
```
\

As expected, the number of missing values in the variable `Decessi` is now equal to:

\
```{r}
sum(is.na(prova$Decessi))
```
\

In the `prova` dataset, the number of observations where the average number of residents is equal to 0 is even:

\
```{r}
nrow(prova[prova$pop_media==0,])
```
\

Since these observations do not provide information by having an average number of residents, it is decided to discard them.

\
```{r}
prova <- prova[prova$pop_media!=0,]
```
\

Invece ora si controlla se ci sono osservazioni in cui il numero di decessi Ã¨ superiore al numero medio di residenti.

\
```{r}
nrow(prova[prova$Decessi>prova$pop_media,])
```
\

Instead, one now checks whether there are observations in which the number of deaths is higher than the average number of residents.

\
```{r}
prova <- prova[prova$Decessi<=prova$pop_media,]
```
\

## Merge with income data

Secondly, I merge the previous dataset `prova` and the `reddito_merge` dataset, of which we do not consider the `Territorio` column to avoid problems with municipal names (which we discussed in `Tesi Data pre-processing.Rmd`). 

\
```{r}
prova2 <- merge(prova, reddito_merge)
```
\

## Merge with education data

Finally, we merge with the `istruzione_merge` dataset. 

\
```{r}
complete_df <- merge(prova2, istruzione_merge)
```
\

We save the `complete_df` dataset in `Rdata` and `CSV` format.
\
```{r}
complete_df <- complete_df[,c("ITTER107","Territorio","SESSO","CL_ETA","INCOME","INCOME_RANK",
                              "EDUC","EDUC_RANK","TIME","Decessi","pop_media")]
complete_df <- complete_df[order(complete_df$ITTER107,complete_df$SESSO,complete_df$CL_ETA,
                                 complete_df$INCOME_RANK,complete_df$EDUC_RANK,complete_df$TIME),]
save(complete_df, file = "complete_df.Rdata")
write.csv(complete_df,"complete_df.csv")
```
\

We extract the female and male gender data.

\
```{r}
options(digits = 5)
male <- subset(complete_df,SESSO==1)
female <- subset(complete_df,SESSO==2)
```
\

We aggregate the age classes in order to decrease their number, resulting in age classes "0-24", "25-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84" and "85+".

\
```{r}
male <- male %>%
  mutate(AgeGroup = case_when(
    CL_ETA %in% c(1,2,3,4,5) ~ 1,
    CL_ETA %in% c(6,7,8,9,10) ~ 2,
    CL_ETA %in% 11 ~ 3,
    CL_ETA %in% 12 ~ 4,
    CL_ETA %in% 13 ~ 5,
    CL_ETA %in% 14 ~ 6,
    CL_ETA %in% 15 ~ 7,
    CL_ETA %in% 16 ~ 8,
    CL_ETA %in% 17 ~ 9,
    CL_ETA %in% 18 ~ 10))
male <- male %>%
  group_by(ITTER107, Territorio, TIME, SESSO, AgeGroup, INCOME_RANK, EDUC_RANK) %>%
  summarise(
    Decessi = sum(Decessi),
    pop_media = sum(pop_media),
    .groups = "drop"
  )

female <- female %>%
  mutate(AgeGroup = case_when(
    CL_ETA %in% c(1,2,3,4,5) ~ 1,
    CL_ETA %in% c(6,7,8,9,10) ~ 2,
    CL_ETA %in% 11 ~ 3,
    CL_ETA %in% 12 ~ 4,
    CL_ETA %in% 13 ~ 5,
    CL_ETA %in% 14 ~ 6,
    CL_ETA %in% 15 ~ 7,
    CL_ETA %in% 16 ~ 8,
    CL_ETA %in% 17 ~ 9,
    CL_ETA %in% 18 ~ 10))
female <- female %>%
  group_by(ITTER107, Territorio, TIME, SESSO, AgeGroup, INCOME_RANK, EDUC_RANK) %>%
  summarise(
    Decessi = sum(Decessi),
    pop_media = sum(pop_media),
    .groups = "drop"
  )
```
\

Auxiliary time variables are created with which to implement models that treat the time variable as a continuous variable.

\
```{r}
male$TIME1 <- male$TIME-2011
female$TIME1 <- female$TIME-2011
```
\

We sort the data.

\
```{r}
male <- male[order(male$ITTER107,male$AgeGroup,male$TIME),]
female <- female[order(female$ITTER107,female$AgeGroup,female$TIME),]
```
\

We save the two previous datasets in .CSV format.

\
```{r}
write.csv(male,file = "male.csv")
write.csv(female,file = "female.csv")
```
\

# MAIN ANALYSIS

Now we try to implement models to calculate RII and SII using GEE (Generalized Estimating Equations) approach in order to take into account the hierarchical structure of the data (clusters are to be defined by the municipality and age groups and data are longitudinal), attributing an appropriate correlation structure.

## RII

We now implement the models for the calculation of education rank (`EDUC_RANK`) and income rank (`INCOME_RANK`) over the time period 2011 to 2022. I implement separate models for the male gender and the female gender.


In the models I'm going to implement, the dependent variable is the number of deaths, the offset is the logarithm of the mid-year population, and the covariates are the categorical variable representing age classes, time, rank and the interaction between rank and time. In these models, the link function used is the logarithm (the canonical one). Furthermore, the distribution family of the dependent varaible is 'quasipoisson' in the case where the dispersion parameter is >1, 'poisson' otherwise.


Depending on how we treat the time variable, we implement 3 types of models:

1) a model in which the time varaible is treated as a categorical variable, in order to plot the observed point and interval estimates over the observation time;

2) a model in which the time variable is treated as a continuous variable and all years of the observation period are considered, in order to be able to visualise the trend of the RII;

3) a model in which the time variable is treated as a continuous variable and all the years of the observation period are considered except for the calendar years 2020, 201 and 2022, in order to predict the trend of the RII using pre-pandemic data.

### Men

#### Education

The model is created in which the time variable is categorical and income-related inequalities are considered.

\
```{r}
educRII_male_GEE_fit1 <- geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+factor(TIME)+EDUC_RANK+EDUC_RANK:factor(TIME),
                                data = male, 
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family = poisson(link = "log"), 
                                corstr = "ar1")
summary(educRII_male_GEE_fit1)
```
\

I now attempt to derive the RII estimates for the educational rank in men in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
educRII_male_GEE <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(complete_df$TIME))
# RII calculation
male_educ_coef <- summary(educRII_male_GEE_fit1)$coefficients[22:33,1:2]
male_educ_vcov <- vcov(educRII_male_GEE_fit1)[22:33,22:33]
for(anno in unique(educRII_male_GEE$TIME)){
  if(anno==2011){
    #logRII
    educRII_male_GEE$logRII[educRII_male_GEE$TIME==anno] <- male_educ_coef[1,1]
    #SE of log(RII)
    educRII_male_GEE$selogrii[educRII_male_GEE$TIME==anno] <- sqrt(male_educ_vcov[1,1])
    #SE of RII
    educRII_male_GEE$SE[educRII_male_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE$logRII[educRII_male_GEE$TIME==anno],
                                   educRII_male_GEE$selogrii[educRII_male_GEE$TIME==anno]^2)
    }
  else{
    #logRII
    educRII_male_GEE$logRII[educRII_male_GEE$TIME==anno] <- male_educ_coef[1,1]+male_educ_coef[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),1]
    #SE of log(RII)
    educRII_male_GEE$selogrii[educRII_male_GEE$TIME==anno] <- sqrt(male_educ_vcov[1,1]+male_educ_vcov[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),paste0("factor(TIME)",as.character(anno),":EDUC_RANK")]+2*male_educ_vcov[1,paste0("factor(TIME)",as.character(anno),":EDUC_RANK")])
    #SE of RII
    educRII_male_GEE$SE[educRII_male_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE$logRII[educRII_male_GEE$TIME==anno],
                                   educRII_male_GEE$selogrii[educRII_male_GEE$TIME==anno]^2)
  }
}
educRII_male_GEE$RII <- exp(educRII_male_GEE$logRII)
educRII_male_GEE$lower95 <- exp(educRII_male_GEE$logRII-1.96*educRII_male_GEE$selogrii)
educRII_male_GEE$upper95 <- exp(educRII_male_GEE$logRII+1.96*educRII_male_GEE$selogrii)
```
\

Now the time variable is continuous, using data related to 2011-2022

\
```{r}
educRII_male_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                              data=male,
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family=poisson(link="log"),
                              corstr = "ar1")
summary(educRII_male_GEE_fit2)
```
\

95\% confidence interval of time-education rank interaction term.

\
```{r}
c(coef(educRII_male_GEE_fit2)["TIME1:EDUC_RANK"]-1.96*summary(educRII_male_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2],
  coef(educRII_male_GEE_fit2)["TIME1:EDUC_RANK"]+1.96*summary(educRII_male_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2])
```
\

We now calculate the RII estimates for the rank of education in men obtained with the previous model.

\
```{r}
educRII_male_GEE2 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educRII_male_GEE2$TIME)){
  #logRII
  educRII_male_GEE2$logRII[educRII_male_GEE2$TIME==anno] <- coef(educRII_male_GEE_fit2)["EDUC_RANK"]+(anno-2011)*coef(educRII_male_GEE_fit2)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_male_GEE2$selogrii[educRII_male_GEE2$TIME==anno] <- sqrt(vcov(educRII_male_GEE_fit2)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_male_GEE_fit2)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_male_GEE_fit2)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_male_GEE2$SE[educRII_male_GEE2$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE2$logRII[educRII_male_GEE2$TIME==anno],
                                   educRII_male_GEE2$selogrii[educRII_male_GEE2$TIME==anno]^2)
}
educRII_male_GEE2$RII <- exp(educRII_male_GEE2$logRII)
educRII_male_GEE2$lower95 <- exp(educRII_male_GEE2$logRII-1.96*educRII_male_GEE2$selogrii)
educRII_male_GEE2$upper95 <- exp(educRII_male_GEE2$logRII+1.96*educRII_male_GEE2$selogrii)
```
\

Next, we want to study what would happen if we did not consider post-COVID-19 years. Then we fit the previous model by considering the male gender data set excluding the observations for the year 2020,201 and 2022.

\
```{r}
educRII_male_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                              data=subset(male,TIME!=2020 & TIME!=2021 & TIME!=2022),
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family=poisson(link="log"),
                              corstr = "ar1")
summary(educRII_male_GEE_fit3)
```
\

95\% confidence interval of time-education rank interaction term.

\
```{r}
c(coef(educRII_male_GEE_fit3)["TIME1:EDUC_RANK"]-1.96*summary(educRII_male_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2],
  coef(educRII_male_GEE_fit3)["TIME1:EDUC_RANK"]+1.96*summary(educRII_male_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2])
```
\

We now calculate the RII estimates for the rank of education in men obtained with the previous model.

\
```{r}
educRII_male_GEE3 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educRII_male_GEE3$TIME)){
  #logRII
  educRII_male_GEE3$logRII[educRII_male_GEE3$TIME==anno] <- coef(educRII_male_GEE_fit3)["EDUC_RANK"]+(anno-2011)*coef(educRII_male_GEE_fit3)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_male_GEE3$selogrii[educRII_male_GEE3$TIME==anno] <- sqrt(vcov(educRII_male_GEE_fit3)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_male_GEE_fit3)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_male_GEE_fit3)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_male_GEE3$SE[educRII_male_GEE3$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE3$logRII[educRII_male_GEE3$TIME==anno],
                                   educRII_male_GEE3$selogrii[educRII_male_GEE3$TIME==anno]^2)
}
educRII_male_GEE3$RII <- exp(educRII_male_GEE3$logRII)
educRII_male_GEE3$lower95 <- exp(educRII_male_GEE3$logRII-1.96*educRII_male_GEE3$selogrii)
educRII_male_GEE3$upper95 <- exp(educRII_male_GEE3$logRII+1.96*educRII_male_GEE3$selogrii)
```
\

#### Income

At this point, considering the data for the male gender, we fit a model to calculate the RII relative to income rank, in which the time variable is considered as a categorical variable.

\
```{r}
incomeRII_male_GEE_fit1<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+factor(TIME)+INCOME_RANK+INCOME_RANK:factor(TIME),
                               data = male, 
                               id = interaction(ITTER107,factor(AgeGroup)),
                               family = poisson(link = "log"), 
                               corstr = "ar1")
summary(incomeRII_male_GEE_fit1)
```
\

I now attempt to derive the RII estimates for the educational rank in men in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
incomeRII_male_GEE <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(complete_df$TIME))
# RII calculation
male_income_coef <- summary(incomeRII_male_GEE_fit1)$coefficients[22:33,1:2]
male_income_vcov <- vcov(incomeRII_male_GEE_fit1)[22:33,22:33]
for(anno in unique(incomeRII_male_GEE$TIME)){
  if(anno==2011){
    #logRII
    incomeRII_male_GEE$logRII[incomeRII_male_GEE$TIME==anno] <- male_income_coef[1,1]
    #SE of log(RII)
    incomeRII_male_GEE$selogrii[incomeRII_male_GEE$TIME==anno] <- sqrt(male_income_vcov[1,1])
    #SE of RII
    incomeRII_male_GEE$SE[incomeRII_male_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE$logRII[incomeRII_male_GEE$TIME==anno],
                                   incomeRII_male_GEE$selogrii[incomeRII_male_GEE$TIME==anno]^2)
    }
  else{
    #logRII
    incomeRII_male_GEE$logRII[incomeRII_male_GEE$TIME==anno] <- male_income_coef[1,1]+male_income_coef[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),1]
    #SE of log(RII)
    incomeRII_male_GEE$selogrii[incomeRII_male_GEE$TIME==anno] <- sqrt(male_income_vcov[1,1]+male_income_vcov[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),paste0("factor(TIME)",as.character(anno),":INCOME_RANK")]+2*male_income_vcov[1,paste0("factor(TIME)",as.character(anno),":INCOME_RANK")])
    #SE of RII
    incomeRII_male_GEE$SE[incomeRII_male_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE$logRII[incomeRII_male_GEE$TIME==anno],
                                   incomeRII_male_GEE$selogrii[incomeRII_male_GEE$TIME==anno]^2)
  }
}
incomeRII_male_GEE$RII <- exp(incomeRII_male_GEE$logRII)
incomeRII_male_GEE$lower95 <- exp(incomeRII_male_GEE$logRII-1.96*incomeRII_male_GEE$selogrii)
incomeRII_male_GEE$upper95 <- exp(incomeRII_male_GEE$logRII+1.96*incomeRII_male_GEE$selogrii)
```
\

Secondly, still considering the data of men, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank.
\
```{r}
incomeRII_male_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                                data=male,
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(incomeRII_male_GEE_fit2)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_male_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2],
  coef(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_male_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2])
```
\

We now calculate the estimates of RII related to income rank in men obtained with the previous model.

\
```{r}
incomeRII_male_GEE2 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeRII_male_GEE2$TIME)){
  #logRII
  incomeRII_male_GEE2$logRII[incomeRII_male_GEE2$TIME==anno] <- coef(incomeRII_male_GEE_fit2)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_male_GEE2$selogrii[incomeRII_male_GEE2$TIME==anno] <- sqrt(vcov(incomeRII_male_GEE_fit2)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_male_GEE_fit2)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_male_GEE2$SE[incomeRII_male_GEE2$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE2$logRII[incomeRII_male_GEE2$TIME==anno],
                                   incomeRII_male_GEE2$selogrii[incomeRII_male_GEE2$TIME==anno]^2)
}
incomeRII_male_GEE2$RII <- exp(incomeRII_male_GEE2$logRII)
incomeRII_male_GEE2$lower95 <- exp(incomeRII_male_GEE2$logRII-1.96*incomeRII_male_GEE2$selogrii)
incomeRII_male_GEE2$upper95 <- exp(incomeRII_male_GEE2$logRII+1.96*incomeRII_male_GEE2$selogrii)
```
\

Now we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeRII_male_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                                data=subset(male,TIME!=2020 & TIME!=2021 & TIME!=2022),
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(incomeRII_male_GEE_fit3)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_male_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2],
  coef(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_male_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2])
```
\

We now calculate the RII estimates for the rank of education in men obtained with the previous model.

\
```{r}
incomeRII_male_GEE3 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeRII_male_GEE3$TIME)){
  #logRII
  incomeRII_male_GEE3$logRII[incomeRII_male_GEE3$TIME==anno] <- coef(incomeRII_male_GEE_fit3)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_male_GEE3$selogrii[incomeRII_male_GEE3$TIME==anno] <- sqrt(vcov(incomeRII_male_GEE_fit3)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_male_GEE_fit3)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_male_GEE3$SE[incomeRII_male_GEE3$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE3$logRII[incomeRII_male_GEE3$TIME==anno],
                                   incomeRII_male_GEE3$selogrii[incomeRII_male_GEE3$TIME==anno]^2)
}
incomeRII_male_GEE3$RII <- exp(incomeRII_male_GEE3$logRII)
incomeRII_male_GEE3$lower95 <- exp(incomeRII_male_GEE3$logRII-1.96*incomeRII_male_GEE3$selogrii)
incomeRII_male_GEE3$upper95 <- exp(incomeRII_male_GEE3$logRII+1.96*incomeRII_male_GEE3$selogrii)
```
\

### Women

#### Education

Now I repeat the previous analysis considering the data for the female gender.


We implement the model in which the time variable is categorical.

\
```{r}
educRII_female_GEE_fit1<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+factor(TIME)+EDUC_RANK+EDUC_RANK:factor(TIME),
                                data=female,
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(educRII_female_GEE_fit1)
```
\

I now try to derive the RII estimates for the educational rank of women in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
educRII_female_GEE <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(complete_df$TIME))
# RII calculation
female_educ_coef <- summary(educRII_female_GEE_fit1)$coefficients[22:33,1:2]
female_educ_vcov <- vcov(educRII_female_GEE_fit1)[22:33,22:33]
for(anno in unique(educRII_female_GEE$TIME)){
  if(anno==2011){
    #logRII
    educRII_female_GEE$logRII[educRII_female_GEE$TIME==anno] <- female_educ_coef[1,1]
    #SE of log(RII)
    educRII_female_GEE$selogrii[educRII_female_GEE$TIME==anno] <- sqrt(female_educ_vcov[1,1])
    #SE of RII
    educRII_female_GEE$SE[educRII_female_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE$logRII[educRII_female_GEE$TIME==anno],
                                   educRII_female_GEE$selogrii[educRII_female_GEE$TIME==anno]^2)
    }
  else{
    #logRII
    educRII_female_GEE$logRII[educRII_female_GEE$TIME==anno] <- female_educ_coef[1,1]+female_educ_coef[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),1]
    #SE of log(RII)
    educRII_female_GEE$selogrii[educRII_female_GEE$TIME==anno] <- sqrt(female_educ_vcov[1,1]+female_educ_vcov[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),paste0("factor(TIME)",as.character(anno),":EDUC_RANK")]+2*female_educ_vcov[1,paste0("factor(TIME)",as.character(anno),":EDUC_RANK")])
    #SE of RII
    educRII_female_GEE$SE[educRII_female_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE$logRII[educRII_female_GEE$TIME==anno],
                                   educRII_female_GEE$selogrii[educRII_female_GEE$TIME==anno]^2)
  }
}
educRII_female_GEE$RII <- exp(educRII_female_GEE$logRII)
educRII_female_GEE$lower95 <- exp(educRII_female_GEE$logRII-1.96*educRII_female_GEE$selogrii)
educRII_female_GEE$upper95 <- exp(educRII_female_GEE$logRII+1.96*educRII_female_GEE$selogrii)
```
\

Now we implement the second model in which the time variable is conyinuous.

\
```{r}
educRII_female_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                                data=female,
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(educRII_female_GEE_fit2)
```
\

95\% cofidence interval of the interaction term.

\
```{r}
c(coef(educRII_female_GEE_fit2)["TIME1:EDUC_RANK"]-1.96*summary(educRII_female_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2],
  coef(educRII_female_GEE_fit2)["TIME1:EDUC_RANK"]+1.96*summary(educRII_female_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2])
```
\

We now calculate the RII estimates for the rank of education in women obtained with the previous model.

\
```{r}
educRII_female_GEE2 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educRII_female_GEE2$TIME)){
  #logRII
  educRII_female_GEE2$logRII[educRII_female_GEE2$TIME==anno] <- coef(educRII_female_GEE_fit2)["EDUC_RANK"]+(anno-2011)*coef(educRII_female_GEE_fit2)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_female_GEE2$selogrii[educRII_female_GEE2$TIME==anno] <- sqrt(vcov(educRII_female_GEE_fit2)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_female_GEE_fit2)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_female_GEE_fit2)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_female_GEE2$SE[educRII_female_GEE2$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE2$logRII[educRII_female_GEE2$TIME==anno],
                                   educRII_female_GEE2$selogrii[educRII_female_GEE2$TIME==anno]^2)
}
educRII_female_GEE2$RII <- exp(educRII_female_GEE2$logRII)
educRII_female_GEE2$lower95 <- exp(educRII_female_GEE2$logRII-1.96*educRII_female_GEE2$selogrii)
educRII_female_GEE2$upper95 <- exp(educRII_female_GEE2$logRII+1.96*educRII_female_GEE2$selogrii)
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and educational rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
educRII_female_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                                data=subset(female,TIME!=2020 & TIME!=2021 & TIME!=2022),
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(educRII_female_GEE_fit3)
```
\

95\% cofidence interval of the interaction term.

\
```{r}
c(coef(educRII_female_GEE_fit3)["TIME1:EDUC_RANK"]-1.96*summary(educRII_female_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2],
  coef(educRII_female_GEE_fit3)["TIME1:EDUC_RANK"]+1.96*summary(educRII_female_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2])
```
\

We calculate the RII estimates for the rank of education in women obtained with the previous model.

\
```{r}
educRII_female_GEE3 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educRII_female_GEE3$TIME)){
  #logRII
  educRII_female_GEE3$logRII[educRII_female_GEE3$TIME==anno] <- coef(educRII_female_GEE_fit3)["EDUC_RANK"]+(anno-2011)*coef(educRII_female_GEE_fit3)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_female_GEE3$selogrii[educRII_female_GEE3$TIME==anno] <- sqrt(vcov(educRII_female_GEE_fit3)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_female_GEE_fit3)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_female_GEE_fit3)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_female_GEE3$SE[educRII_female_GEE3$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE3$logRII[educRII_female_GEE3$TIME==anno],
                                   educRII_female_GEE3$selogrii[educRII_female_GEE3$TIME==anno]^2)
}
educRII_female_GEE3$RII <- exp(educRII_female_GEE3$logRII)
educRII_female_GEE3$lower95 <- exp(educRII_female_GEE3$logRII-1.96*educRII_female_GEE3$selogrii)
educRII_female_GEE3$upper95 <- exp(educRII_female_GEE3$logRII+1.96*educRII_female_GEE3$selogrii)
```
\

#### Income

Considering the data for the female gender, we fit a model to calculate the RII relative to income rank, in which the time variable is considered as a categorical variable.

\
```{r}
incomeRII_female_GEE_fit1<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+factor(TIME)+INCOME_RANK+INCOME_RANK:factor(TIME),
                                  data=female,
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family=poisson(link="log"),
                                  corstr = "ar1")
summary(incomeRII_female_GEE_fit1)
```
\

We now attempt to derive the RII estimates for the income rank in men in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
incomeRII_female_GEE <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(complete_df$TIME))
# RII calculation
female_income_coef <- summary(incomeRII_female_GEE_fit1)$coefficients[22:33,1:2]
female_income_vcov <- vcov(incomeRII_female_GEE_fit1)[22:33,22:33]
for(anno in unique(incomeRII_female_GEE$TIME)){
  if(anno==2011){
    #logRII
    incomeRII_female_GEE$logRII[incomeRII_female_GEE$TIME==anno] <- female_income_coef[1,1]
    #SE of log(RII)
    incomeRII_female_GEE$selogrii[incomeRII_female_GEE$TIME==anno] <- sqrt(female_income_vcov[1,1])
    #SE of RII
    incomeRII_female_GEE$SE[incomeRII_female_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE$logRII[incomeRII_female_GEE$TIME==anno],
                                   incomeRII_female_GEE$selogrii[incomeRII_female_GEE$TIME==anno]^2)
    }
  else{
    #logRII
    incomeRII_female_GEE$logRII[incomeRII_female_GEE$TIME==anno] <- female_income_coef[1,1]+female_income_coef[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),1]
    #SE of log(RII)
    incomeRII_female_GEE$selogrii[incomeRII_female_GEE$TIME==anno] <- sqrt(female_income_vcov[1,1]+female_income_vcov[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),paste0("factor(TIME)",as.character(anno),":INCOME_RANK")]+2*female_income_vcov[1,paste0("factor(TIME)",as.character(anno),":INCOME_RANK")])
    #SE of RII
    incomeRII_female_GEE$SE[incomeRII_female_GEE$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE$logRII[incomeRII_female_GEE$TIME==anno],
                                   incomeRII_female_GEE$selogrii[incomeRII_female_GEE$TIME==anno]^2)
  }
}
incomeRII_female_GEE$RII <- exp(incomeRII_female_GEE$logRII)
incomeRII_female_GEE$lower95 <- exp(incomeRII_female_GEE$logRII-1.96*incomeRII_female_GEE$selogrii)
incomeRII_female_GEE$upper95 <- exp(incomeRII_female_GEE$logRII+1.96*incomeRII_female_GEE$selogrii)
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank.

\
```{r}
incomeRII_female_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                                  data=female,
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family=poisson(link="log"),
                                  corstr = "ar1")
summary(incomeRII_female_GEE_fit2)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_female_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2],
  coef(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_female_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2])
```
\

We now calculate the estimates of RII related to income rank in women obtained with the previous model.

\
```{r}
incomeRII_female_GEE2 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeRII_female_GEE2$TIME)){
  #logRII
  incomeRII_female_GEE2$logRII[incomeRII_female_GEE2$TIME==anno] <- coef(incomeRII_female_GEE_fit2)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_female_GEE2$selogrii[incomeRII_female_GEE2$TIME==anno] <- sqrt(vcov(incomeRII_female_GEE_fit2)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_female_GEE_fit2)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_female_GEE2$SE[incomeRII_female_GEE2$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE2$logRII[incomeRII_female_GEE2$TIME==anno],
                                   incomeRII_female_GEE2$selogrii[incomeRII_female_GEE2$TIME==anno]^2)
}
incomeRII_female_GEE2$RII <- exp(incomeRII_female_GEE2$logRII)
incomeRII_female_GEE2$lower95 <- exp(incomeRII_female_GEE2$logRII-1.96*incomeRII_female_GEE2$selogrii)
incomeRII_female_GEE2$upper95 <- exp(incomeRII_female_GEE2$logRII+1.96*incomeRII_female_GEE2$selogrii)
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeRII_female_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                                  data=subset(female,TIME!=2020 & TIME!=2021 & TIME!=2022),
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family=poisson(link="log"),
                                  corstr = "ar1")
summary(incomeRII_female_GEE_fit3)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_female_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2],
  coef(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_female_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2])
```
\

We now calculate the RII estimates for the rank of income in men obtained with the previous model.

\
```{r}
incomeRII_female_GEE3 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeRII_female_GEE3$TIME)){
  #logRII
  incomeRII_female_GEE3$logRII[incomeRII_female_GEE3$TIME==anno] <- coef(incomeRII_female_GEE_fit3)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_female_GEE3$selogrii[incomeRII_female_GEE3$TIME==anno] <- sqrt(vcov(incomeRII_female_GEE_fit3)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_female_GEE_fit3)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_female_GEE3$SE[incomeRII_female_GEE3$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE3$logRII[incomeRII_female_GEE3$TIME==anno],
                                   incomeRII_female_GEE3$selogrii[incomeRII_female_GEE3$TIME==anno]^2)
}
incomeRII_female_GEE3$RII <- exp(incomeRII_female_GEE3$logRII)
incomeRII_female_GEE3$lower95 <- exp(incomeRII_female_GEE3$logRII-1.96*incomeRII_female_GEE3$selogrii)
incomeRII_female_GEE3$upper95 <- exp(incomeRII_female_GEE3$logRII+1.96*incomeRII_female_GEE3$selogrii)
```
\

At this point I create the dataset in which I save the estimates for RII obtained with all previous models.


We create the dataset in which I save the point-interval estimates of RII for education rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the GEE models in which time variable is considered as a categorical variable.

\
```{r}
RII_GEE_2011_2022 <- rbind(educRII_male_GEE,educRII_female_GEE,incomeRII_male_GEE,incomeRII_female_GEE)
RII_GEE_2011_2022$SESSO <- factor(RII_GEE_2011_2022$SESSO,levels = c(1,2),labels = c("Male","Female"))
RII_GEE_2011_2022 <- RII_GEE_2011_2022[order(RII_GEE_2011_2022$VAR,RII_GEE_2011_2022$SESSO,RII_GEE_2011_2022$TIME),]
save(RII_GEE_2011_2022,file="RII_GEE_2011_2022.Rdata")
```
\

We create an additional dataset in which the point estimates of RII for education rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the models in which time varaible is considered as a continiuous variable are saved.

\
```{r}
predRII_GEE_2011_2022 <- rbind(educRII_male_GEE2,educRII_female_GEE2,incomeRII_male_GEE2,incomeRII_female_GEE2)
predRII_GEE_2011_2022$SESSO <- factor(predRII_GEE_2011_2022$SESSO,levels = c(1,2),labels = c("Male","Female"))
predRII_GEE_2011_2022 <- predRII_GEE_2011_2022[order(predRII_GEE_2011_2022$VAR,predRII_GEE_2011_2022$SESSO,predRII_GEE_2011_2022$TIME),]
save(predRII_GEE_2011_2022,file="predRII_GEE_2011_2022.Rdata")
```
\

We create a third dataset in which the point estimates of RII for education rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the models in which time variable is considered as a continiuous variable, using data between 2011 and 2019 for the prediction, are saved.

\
```{r}
predRII_GEE_precovid <- rbind(educRII_male_GEE3,educRII_female_GEE3,incomeRII_male_GEE3,incomeRII_female_GEE3)
predRII_GEE_precovid$SESSO <- factor(predRII_GEE_precovid$SESSO,levels = c(1,2),labels = c("Male","Female"))
predRII_GEE_precovid <- predRII_GEE_precovid[order(predRII_GEE_precovid$VAR,predRII_GEE_precovid$SESSO,predRII_GEE_precovid$TIME),]
save(predRII_GEE_precovid,file="predRII_GEE_precovid.Rdata")
```
\

## SII

I now implement the models for calculating the SII for education rank (EDUC_RANK) and income rank (INCOME_RANK) over the time period 2011 to 2022. I implement separate models for the male and female genders.

In the models I am going to implement, the dependent variable is the number of deaths and the covariates are the average two-year population, the variable representing the age classes, the interaction between the average two-year population and the categorical variable of age, time, the variable given by the product between the average two-year population and rank and the interaction between the latter variable and time. In these models, the link function used is the identity function (the non-canonical one).


Depending on how I treat the time varaible, I implement 3 types of models:

1) a model in which the time varaible is treated as a categorical variable, in order to be able to plot the observed point and interval estimates over the observation time;

2) a model in which the time variable is treated as a continuous variable and all years of the observation period are considered, in order to be able to visualise the trend of the SII;

3) a model in which the time variable is treated as continuous and all years of the observation period are considered except for the calendar years 2020, 2021 and 2022, in order to visualise the SII trend in the situation in which the post-COVID-19 years are not considered.

### Men

#### Education

We start by implementing the models for calculating the SII related to the instruction rank.

\
```{r}
educSII_male_GEE_fit1 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK):factor(TIME)-1,
                               data=male, 
                               id = interaction(ITTER107,factor(AgeGroup)),
                               family = poisson(link = "identity"), 
                               corstr = "ar1")
summary(educSII_male_GEE_fit1)
```
\

SII estimates of the rank of education in men.

\
```{r}
educSII_male_GEE <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(complete_df$TIME))
for(anno in unique(educSII_male_GEE)){
  #SII
  educSII_male_GEE$SII[educSII_male_GEE$TIME==anno] <- summary(educSII_male_GEE_fit1)$coefficients[paste0("I(pop_media * EDUC_RANK):factor(TIME)",as.character(anno)),1]
  #SE
  educSII_male_GEE$SE[educSII_male_GEE$TIME==anno] <- summary(educSII_male_GEE_fit1)$coefficients[paste0("I(pop_media * EDUC_RANK):factor(TIME)",as.character(anno)),2]
  
}
educSII_male_GEE$lower95 <- educSII_male_GEE$SII-1.96*educSII_male_GEE$SE
educSII_male_GEE$upper95 <- educSII_male_GEE$SII+1.96*educSII_male_GEE$SE
```
\

We now implement a second model in which I treat the time variable as a continuous variable and consider the entire observation period.

\
```{r}
educSII_male_GEE_fit2 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                         data=male, 
                         id = interaction(ITTER107,factor(AgeGroup)),
                         family = poisson(link = "identity"), 
                         corstr = "ar1")
summary(educSII_male_GEE_fit2)
```
\

95\% Confidence interval of the interaction term.

\
```{r}
c(coef(educSII_male_GEE_fit2)["I(pop_media * EDUC_RANK):TIME1"]-1.96*summary(educSII_male_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK):TIME1",2],
  coef(educSII_male_GEE_fit2)["I(pop_media * EDUC_RANK):TIME1"]+1.96*summary(educSII_male_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK):TIME1",2])
```
\

We now calculate the SII estimates of the rank of education in men obtained with the previous model.

\
```{r}
educSII_male_GEE2 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educSII_male_GEE2$TIME)){
  #SII
  educSII_male_GEE2$SII[educSII_male_GEE2$TIME==anno] <- summary(educSII_male_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK)",1]+(anno-2011)*summary(educSII_male_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK):TIME1",1]
  #SE of SII
  educSII_male_GEE2$SE[educSII_male_GEE2$TIME==anno] <- sqrt(vcov(educSII_male_GEE_fit2)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK)"]+(anno-2011)^2*vcov(educSII_male_GEE_fit2)["I(pop_media * EDUC_RANK):TIME1","I(pop_media * EDUC_RANK):TIME1"]+2*(anno-2011)*vcov(educSII_male_GEE_fit2)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK):TIME1"])
}
educSII_male_GEE2$lower95 <- educSII_male_GEE2$SII-1.96*educSII_male_GEE2$SE
educSII_male_GEE2$upper95 <- educSII_male_GEE2$SII+1.96*educSII_male_GEE2$SE
```
\

Next, we want to study what would happen if the years 2020, 2021 and 2022 were not considered. We then fit the previous model by considering the male gender data set excluding the observations for the years 2020, 2021 and 2022.

\
```{r}
educSII_male_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                              data=subset(male,TIME!=2020 & TIME!=2021 & TIME!=2022), 
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family = poisson(link = "identity"), 
                              corstr = "ar1")
summary(educSII_male_GEE_fit3)
```
\

95\% Confidence interval of the interaction term.

\
```{r}
c(coef(educSII_male_GEE_fit3)["I(pop_media * EDUC_RANK):TIME1"]-1.96*summary(educSII_male_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK):TIME1",2],
  coef(educSII_male_GEE_fit3)["I(pop_media * EDUC_RANK):TIME1"]+1.96*summary(educSII_male_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK):TIME1",2])
```
\

We now calculate the SII estimates for the rank of education in men obtained with the previous model.

\
```{r}
educSII_male_GEE3 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educSII_male_GEE3$TIME)){
  #SII
  educSII_male_GEE3$SII[educSII_male_GEE3$TIME==anno] <- summary(educSII_male_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK)",1]+(anno-2011)*summary(educSII_male_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK):TIME1",1]
  #SE of SII
  educSII_male_GEE3$SE[educSII_male_GEE3$TIME==anno] <- sqrt(vcov(educSII_male_GEE_fit3)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK)"]+(anno-2011)^2*vcov(educSII_male_GEE_fit3)["I(pop_media * EDUC_RANK):TIME1","I(pop_media * EDUC_RANK):TIME1"]+2*(anno-2011)*vcov(educSII_male_GEE_fit3)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK):TIME1"])
}
educSII_male_GEE3$lower95 <- educSII_male_GEE3$SII-1.96*educSII_male_GEE3$SE
educSII_male_GEE3$upper95 <- educSII_male_GEE3$SII+1.96*educSII_male_GEE3$SE
```
\

#### Income

At this point, the previous analyses are repeated for the calculation of the SII related to income rank (INCOME_RANK) in men over the observation period.

\
```{r}
incomeSII_male_GEE_fit1 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK):factor(TIME)-1,
                                 data=male, 
                                 id = interaction(ITTER107,factor(AgeGroup)),
                                 family = poisson(link = "identity"), 
                                 corstr = "ar1")
summary(incomeSII_male_GEE_fit1)
```
\

SII estimates of the rank of education in men.

\
```{r}
incomeSII_male_GEE <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(complete_df$TIME))
for(anno in unique(incomeSII_male_GEE)){
  #SII
  incomeSII_male_GEE$SII[incomeSII_male_GEE$TIME==anno] <- summary(incomeSII_male_GEE_fit1)$coefficients[paste0("I(pop_media * INCOME_RANK):factor(TIME)",as.character(anno)),1]
  #SE
  incomeSII_male_GEE$SE[incomeSII_male_GEE$TIME==anno] <- summary(incomeSII_male_GEE_fit1)$coefficients[paste0("I(pop_media * INCOME_RANK):factor(TIME)",as.character(anno)),2]
  
}
incomeSII_male_GEE$lower95 <- incomeSII_male_GEE$SII-1.96*incomeSII_male_GEE$SE
incomeSII_male_GEE$upper95 <- incomeSII_male_GEE$SII+1.96*incomeSII_male_GEE$SE
```
\

I now implement a second model in which I treat the time variable as a continuous variable and consider the entire observation period.

\
```{r}
incomeSII_male_GEE_fit2 <- geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                              data=male, 
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family = poisson(link = "identity"), 
                              corstr = "ar1")
summary(incomeSII_male_GEE_fit2)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeSII_male_GEE_fit2)["I(pop_media * INCOME_RANK):TIME1"]-1.96*summary(incomeSII_male_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK):TIME1",2],
  coef(incomeSII_male_GEE_fit2)["I(pop_media * INCOME_RANK):TIME1"]+1.96*summary(incomeSII_male_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK):TIME1",2])
```
\

We now calculate the SII estimates of income rank in men obtained with the previous model.

\
```{r}
incomeSII_male_GEE2 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeSII_male_GEE2$TIME)){
  #SII
  incomeSII_male_GEE2$SII[incomeSII_male_GEE2$TIME==anno] <- summary(incomeSII_male_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK)",1]+(anno-2011)*summary(incomeSII_male_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK):TIME1",1]
  #SE of SII
  incomeSII_male_GEE2$SE[incomeSII_male_GEE2$TIME==anno] <- sqrt(vcov(incomeSII_male_GEE_fit2)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK)"]+(anno-2011)^2*vcov(incomeSII_male_GEE_fit2)["I(pop_media * INCOME_RANK):TIME1","I(pop_media * INCOME_RANK):TIME1"]+2*(anno-2011)*vcov(incomeSII_male_GEE_fit2)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK):TIME1"])
}
incomeSII_male_GEE2$lower95 <- incomeSII_male_GEE2$SII-1.96*incomeSII_male_GEE2$SE
incomeSII_male_GEE2$upper95 <- incomeSII_male_GEE2$SII+1.96*incomeSII_male_GEE2$SE
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeSII_male_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                                data=subset(male,TIME!=2020 & TIME!=2021 & TIME!=2022), 
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family = poisson(link = "identity"), 
                                corstr = "ar1")
summary(incomeSII_male_GEE_fit3)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeSII_male_GEE_fit3)["I(pop_media * INCOME_RANK):TIME1"]-1.96*summary(incomeSII_male_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK):TIME1",2],
  coef(incomeSII_male_GEE_fit3)["I(pop_media * INCOME_RANK):TIME1"]+1.96*summary(incomeSII_male_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK):TIME1",2])
```
\

We now calculate the SII estimates of income rank in men obtained with the previous model.

\
```{r}
incomeSII_male_GEE3 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeSII_male_GEE3$TIME)){
  #SII
  incomeSII_male_GEE3$SII[incomeSII_male_GEE3$TIME==anno] <- summary(incomeSII_male_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK)",1]+(anno-2011)*summary(incomeSII_male_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK):TIME1",1]
  #SE of SII
  incomeSII_male_GEE3$SE[incomeSII_male_GEE3$TIME==anno] <- sqrt(vcov(incomeSII_male_GEE_fit3)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK)"]+(anno-2011)^2*vcov(incomeSII_male_GEE_fit3)["I(pop_media * INCOME_RANK):TIME1","I(pop_media * INCOME_RANK):TIME1"]+2*(anno-2011)*vcov(incomeSII_male_GEE_fit3)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK):TIME1"])
}
incomeSII_male_GEE3$lower95 <- incomeSII_male_GEE3$SII-1.96*incomeSII_male_GEE3$SE
incomeSII_male_GEE3$upper95 <- incomeSII_male_GEE3$SII+1.96*incomeSII_male_GEE3$SE
```
\

### Women

#### Education

We start by implementing the models for calculating the SII related to the educational rank.

For this particular model, there were convergence problems, so the model had to be implemented using SAS software.

However, the implementation in R is presented.

\
```{r}
educSII_female_GEE_fit1 <- geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK):factor(TIME)-1,
                                  data=female, 
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family = poisson(link = "identity"),
                                  start = coef(educSII_female_fit1))
summary(educSII_female_GEE_fit1)
```
\

Then, we load the model estimates obtained with the SAS software and we proceed to calculate the SII estimates of the rank of education in women.

\
```{r}
educSII_female_GEE_SAS <- read.csv("educSII_female_GEE.csv")
educSII_female_GEE_SAS <- educSII_female_GEE_SAS[-1,]
educSII_female_GEE <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(complete_df$TIME))
for(anno in unique(educSII_female_GEE$TIME)){
  #SII
  educSII_female_GEE$SII[educSII_female_GEE$TIME==anno] <- educSII_female_GEE_SAS$Estimate[educSII_female_GEE_SAS$Level1==anno]
  #SE of SII
  educSII_female_GEE$SE[educSII_female_GEE$TIME==anno] <- educSII_female_GEE_SAS$Stderr[educSII_female_GEE_SAS$Level1==anno]
  #Lower Bound of 95%CI of SII
  educSII_female_GEE$lower95[educSII_female_GEE$TIME==anno] <- educSII_female_GEE_SAS$LowerCL[educSII_female_GEE_SAS$Level1==anno]
  #Upper Bound of 95%CI of SII
  educSII_female_GEE$upper95[educSII_female_GEE$TIME==anno] <- educSII_female_GEE_SAS$UpperCL[educSII_female_GEE_SAS$Level1==anno]
}
```
\

Now we implement a second model in which we treat the time variable as a continuous variable and consider the entire observation period.

\
```{r}
educSII_female_GEE_fit2 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                                 data=female, 
                                 id = interaction(ITTER107,factor(AgeGroup)),
                                 family = poisson(link = "identity"), 
                                 corstr = "ar1")
summary(educSII_female_GEE_fit2)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(educSII_female_GEE_fit2)["I(pop_media * EDUC_RANK):TIME1"]-1.96*summary(educSII_female_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK):TIME1",2],
  coef(educSII_female_GEE_fit2)["I(pop_media * EDUC_RANK):TIME1"]+1.96*summary(educSII_female_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK):TIME1",2])
```
\

We now calculate the SII estimates of the rank of education in men obtained with the previous model.

\
```{r}
educSII_female_GEE2 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educSII_female_GEE2$TIME)){
  #SII
  educSII_female_GEE2$SII[educSII_female_GEE2$TIME==anno] <- summary(educSII_female_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK)",1]+(anno-2011)*summary(educSII_female_GEE_fit2)$coefficients["I(pop_media * EDUC_RANK):TIME1",1]
  #SE of SII
  educSII_female_GEE2$SE[educSII_female_GEE2$TIME==anno] <- sqrt(vcov(educSII_female_GEE_fit2)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK)"]+(anno-2011)^2*vcov(educSII_female_GEE_fit2)["I(pop_media * EDUC_RANK):TIME1","I(pop_media * EDUC_RANK):TIME1"]+2*(anno-2011)*vcov(educSII_female_GEE_fit2)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK):TIME1"])
}
educSII_female_GEE2$lower95 <- educSII_female_GEE2$SII-1.96*educSII_female_GEE2$SE
educSII_female_GEE2$upper95 <- educSII_female_GEE2$SII+1.96*educSII_female_GEE2$SE
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and eduactional rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
educSII_female_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                              data=subset(female,TIME!=2020 & TIME!=2021 & TIME!=2022), 
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family = poisson(link = "identity"), 
                              corstr = "ar1")
summary(educSII_female_GEE_fit3)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(educSII_female_GEE_fit3)["I(pop_media * EDUC_RANK):TIME1"]-1.96*summary(educSII_female_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK):TIME1",2],
  coef(educSII_female_GEE_fit3)["I(pop_media * EDUC_RANK):TIME1"]+1.96*summary(educSII_female_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK):TIME1",2])
```
\

We now calculate the SII estimates for the rank of education in men obtained with the previous model.

\
```{r}
educSII_female_GEE3 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educSII_female_GEE3$TIME)){
  #SII
  educSII_female_GEE3$SII[educSII_female_GEE3$TIME==anno] <- summary(educSII_female_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK)",1]+(anno-2011)*summary(educSII_female_GEE_fit3)$coefficients["I(pop_media * EDUC_RANK):TIME1",1]
  #SE of SII
  educSII_female_GEE3$SE[educSII_female_GEE3$TIME==anno] <- sqrt(vcov(educSII_female_GEE_fit3)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK)"]+(anno-2011)^2*vcov(educSII_female_GEE_fit3)["I(pop_media * EDUC_RANK):TIME1","I(pop_media * EDUC_RANK):TIME1"]+2*(anno-2011)*vcov(educSII_female_GEE_fit3)["I(pop_media * EDUC_RANK)","I(pop_media * EDUC_RANK):TIME1"])
}
educSII_female_GEE3$lower95 <- educSII_female_GEE3$SII-1.96*educSII_female_GEE3$SE
educSII_female_GEE3$upper95 <- educSII_female_GEE3$SII+1.96*educSII_female_GEE3$SE
```
\

#### Income

At this point, the previous analyses are repeated for the calculation of the SII related to income rank (INCOME_RANK) in men over the observation period.

\
```{r}
incomeSII_female_GEE_fit1 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK):factor(TIME)-1,
                                   data=female, 
                                   id = interaction(ITTER107,factor(AgeGroup)),
                                   family = poisson(link = "identity"), 
                                   corstr = "ar1")
summary(incomeSII_female_GEE_fit1)
```
\

SII estimates of the income rank in women.

\
```{r}
incomeSII_female_GEE <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(complete_df$TIME))
for(anno in unique(incomeSII_female_GEE)){
  #SII
  incomeSII_female_GEE$SII[incomeSII_female_GEE$TIME==anno] <- summary(incomeSII_female_GEE_fit1)$coefficients[paste0("I(pop_media * INCOME_RANK):factor(TIME)",as.character(anno)),1]
  #SE
  incomeSII_female_GEE$SE[incomeSII_female_GEE$TIME==anno] <- summary(incomeSII_female_GEE_fit1)$coefficients[paste0("I(pop_media * INCOME_RANK):factor(TIME)",as.character(anno)),2]
  
}
incomeSII_female_GEE$lower95 <- incomeSII_female_GEE$SII-1.96*incomeSII_female_GEE$SE
incomeSII_female_GEE$upper95 <- incomeSII_female_GEE$SII+1.96*incomeSII_female_GEE$SE
```
\

Now we implement a second model in which we treat the time variable as a continuous variable and consider the entire observation period.

\
```{r}
incomeSII_female_GEE_fit2 <- geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                                    data=female, 
                                    id = interaction(ITTER107,factor(AgeGroup)),
                                    family = poisson(link = "identity"), 
                                    corstr = "ar1")
summary(incomeSII_female_GEE_fit2)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeSII_female_GEE_fit2)["I(pop_media * INCOME_RANK):TIME1"]-1.96*summary(incomeSII_female_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK):TIME1",2],
  coef(incomeSII_female_GEE_fit2)["I(pop_media * INCOME_RANK):TIME1"]+1.96*summary(incomeSII_female_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK):TIME1",2])
```
\

We now calculate the SII estimates of income rank in women obtained with the previous model.

\
```{r}
incomeSII_female_GEE2 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeSII_female_GEE2$TIME)){
  #SII
  incomeSII_female_GEE2$SII[incomeSII_female_GEE2$TIME==anno] <- summary(incomeSII_female_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK)",1]+(anno-2011)*summary(incomeSII_female_GEE_fit2)$coefficients["I(pop_media * INCOME_RANK):TIME1",1]
  #SE of SII
  incomeSII_female_GEE2$SE[incomeSII_female_GEE2$TIME==anno] <- sqrt(vcov(incomeSII_female_GEE_fit2)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK)"]+(anno-2011)^2*vcov(incomeSII_female_GEE_fit2)["I(pop_media * INCOME_RANK):TIME1","I(pop_media * INCOME_RANK):TIME1"]+2*(anno-2011)*vcov(incomeSII_female_GEE_fit2)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK):TIME1"])
}
incomeSII_female_GEE2$lower95 <- incomeSII_female_GEE2$SII-1.96*incomeSII_female_GEE2$SE
incomeSII_female_GEE2$upper95 <- incomeSII_female_GEE2$SII+1.96*incomeSII_female_GEE2$SE
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeSII_female_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                                data=subset(female,TIME!=2020 & TIME!=2021 & TIME!=2022), 
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family = poisson(link = "identity"), 
                                corstr = "ar1")
summary(incomeSII_female_GEE_fit3)
```
\

95\% confidence interval of the interaction term.

\
```{r}
c(coef(incomeSII_female_GEE_fit3)["I(pop_media * INCOME_RANK):TIME1"]-1.96*summary(incomeSII_female_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK):TIME1",2],
  coef(incomeSII_female_GEE_fit3)["I(pop_media * INCOME_RANK):TIME1"]+1.96*summary(incomeSII_female_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK):TIME1",2])
```
\

We now calculate the SII estimates of income rank in women obtained with the previous model.

\
```{r}
incomeSII_female_GEE3 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeSII_female_GEE3$TIME)){
  #SII
  incomeSII_female_GEE3$SII[incomeSII_female_GEE3$TIME==anno] <- summary(incomeSII_female_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK)",1]+(anno-2011)*summary(incomeSII_female_GEE_fit3)$coefficients["I(pop_media * INCOME_RANK):TIME1",1]
  #SE of SII
  incomeSII_female_GEE3$SE[incomeSII_female_GEE3$TIME==anno] <- sqrt(vcov(incomeSII_female_GEE_fit3)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK)"]+(anno-2011)^2*vcov(incomeSII_female_GEE_fit3)["I(pop_media * INCOME_RANK):TIME1","I(pop_media * INCOME_RANK):TIME1"]+2*(anno-2011)*vcov(incomeSII_female_GEE_fit3)["I(pop_media * INCOME_RANK)","I(pop_media * INCOME_RANK):TIME1"])
}
incomeSII_female_GEE3$lower95 <- incomeSII_female_GEE3$SII-1.96*incomeSII_female_GEE3$SE
incomeSII_female_GEE3$upper95 <- incomeSII_female_GEE3$SII+1.96*incomeSII_female_GEE3$SE
```
\

We create the dataset in which SII point and interval estimates of education rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the models in which time variable is considered as a categorical variable.

\
```{r}
SII_GEE_2011_2022 <- rbind(educSII_male_GEE,educSII_female_GEE,
                           incomeSII_male_GEE,incomeSII_female_GEE)
SII_GEE_2011_2022$SESSO <- factor(SII_GEE_2011_2022$SESSO,
                                  levels = c(1,2),labels = c("Male","Female"))
SII_GEE_2011_2022 <- SII_GEE_2011_2022[order(SII_GEE_2011_2022$VAR,
                                             SII_GEE_2011_2022$SESSO,
                                             SII_GEE_2011_2022$TIME),]
save(SII_GEE_2011_2022,file="SII_GEE_2011_2022.Rdata")
```
\

We create an additional dataset in which SII point estimates of education rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the models in which the time variable is treated as a continuous variable are saved.

\
```{r}
predSII_GEE_2011_2022 <- rbind(educSII_male_GEE2,educSII_female_GEE2,incomeSII_male_GEE2,incomeSII_female_GEE2)
predSII_GEE_2011_2022$SESSO <- factor(predSII_GEE_2011_2022$SESSO,levels = c(1,2),labels = c("Male","Female"))
predSII_GEE_2011_2022 <- predSII_GEE_2011_2022[order(predSII_GEE_2011_2022$VAR,
                                                     predSII_GEE_2011_2022$SESSO,
                                                     predSII_GEE_2011_2022$TIME),]
save(predSII_GEE_2011_2022,file="predSII_GEE_2011_2022.Rdata")
```
\

We create a third dataset in which SII point estimates of education rank and income rank for both men and women in the period between 2011 and 2022 obtained from the models in which the time variable is treated as a continuous variable and in which the calendar years 2020, 2021 and 2022 are not considered.

\
```{r}
predSII_GEE_precovid <- rbind(educSII_male_GEE3,educSII_female_GEE3,incomeSII_male_GEE3,incomeSII_female_GEE3)
predSII_GEE_precovid$SESSO <- factor(predSII_GEE_precovid$SESSO,levels = c(1,2),labels = c("Male","Female"))
predSII_GEE_precovid <- predSII_GEE_precovid[order(predSII_GEE_precovid$VAR,
                                                           predSII_GEE_precovid$SESSO,
                                                           predSII_GEE_precovid$TIME),]
save(predSII_GEE_precovid,file="predSII_GEE_precovid.Rdata")
```
\

# SENSITIVITY ANALYSIS

The previous analysis is repeated by considering a subset of the starting dataset. In fact, only *small* municipalities are now taken into account, i.e. those municipalities with an average population in the period 2011-2022 (i.e. the period of interest) of less than or equal to 10000 individuals.

\
```{r}
pop_comuni <- complete_df %>%
  group_by(ITTER107,TIME) %>%
  summarise(pop_tot = sum(pop_media),
            .groups = "drop")

pop_media_comuni <- pop_comuni  %>%
  group_by(ITTER107) %>%
  summarise(pop_tot_media = mean(pop_tot),
            .groups = "drop")
```
\

The percentage of municipalities with an average number of residents less than or equal to 10000 during the time period considered (2011-2022) is:

\
```{r}
nrow(pop_media_comuni[pop_media_comuni$pop_tot_media<=10000,])/7901*100
```
\

Then we select the female gender and the male gender as far as small municipalities are concerned.

\
```{r}
codice_comuni <- pop_media_comuni$ITTER107[pop_media_comuni$pop_tot_media<=10000]
piccoli_comuni_male <- subset(male,ITTER107 %in% codice_comuni)
piccoli_comuni_female <- subset(female,ITTER107 %in% codice_comuni)
```
\

We save the two previous datasets in .CSV files.

\
```{r}
write.csv(piccoli_comuni_male,file = "piccoli_comuni_male.csv")
write.csv(piccoli_comuni_female,file = "piccoli_comuni_female.csv")
```
\

## RII

We now implement the models for the computation of RII related to education rank (EDUC_RANK) and income rank (INCOME_RANK) over the time period 2011 to 2022. We implement separate models for male and female gender.


We implement models similar to the previous ones in which we only consider data from small municipalities using GEE approach with AR1 correlation structure and clusters defined by the interaction between ITTER107 and age classes.

### Men

#### Education

Model for the estimation of RII related to educational rank among men, where time variable is treated as categorical variable.

\
```{r}
educRII_male_GEE_fit1 <- geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+
                                  factor(TIME)+EDUC_RANK+EDUC_RANK:factor(TIME),
                               data = piccoli_comuni_male, 
                               id = interaction(ITTER107,factor(AgeGroup)),
                               family = poisson(link = "log"), 
                               corstr = "ar1")
summary(educRII_male_GEE_fit1)
```
\

We now attempt to derive the RII estimates for the educational rank in men in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
educRII_male_GEE_piccoli <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(complete_df$TIME))
# RII calculation
male_educ_coef <- summary(educRII_male_GEE_fit1)$coefficients[22:33,1:2]
male_educ_vcov <- vcov(educRII_male_GEE_fit1)[22:33,22:33]
for(anno in unique(educRII_male_GEE_piccoli$TIME)){
  if(anno==2011){
    #logRII
    educRII_male_GEE_piccoli$logRII[educRII_male_GEE_piccoli$TIME==anno] <- male_educ_coef[1,1]
    #SE of log(RII)
    educRII_male_GEE_piccoli$selogrii[educRII_male_GEE_piccoli$TIME==anno] <- sqrt(male_educ_vcov[1,1])
    #SE of RII
    educRII_male_GEE_piccoli$SE[educRII_male_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE_piccoli$logRII[educRII_male_GEE_piccoli$TIME==anno],
                                   educRII_male_GEE_piccoli$selogrii[educRII_male_GEE_piccoli$TIME==anno]^2)
    }
  else{
    #logRII
    educRII_male_GEE_piccoli$logRII[educRII_male_GEE_piccoli$TIME==anno] <- male_educ_coef[1,1]+male_educ_coef[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),1]
    #SE of log(RII)
    educRII_male_GEE_piccoli$selogrii[educRII_male_GEE_piccoli$TIME==anno] <- sqrt(male_educ_vcov[1,1]+male_educ_vcov[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),paste0("factor(TIME)",as.character(anno),":EDUC_RANK")]+2*male_educ_vcov[1,paste0("factor(TIME)",as.character(anno),":EDUC_RANK")])
    #SE of RII
    educRII_male_GEE_piccoli$SE[educRII_male_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE_piccoli$logRII[educRII_male_GEE_piccoli$TIME==anno],
                                   educRII_male_GEE_piccoli$selogrii[educRII_male_GEE_piccoli$TIME==anno]^2)
  }
}
educRII_male_GEE_piccoli$RII <- exp(educRII_male_GEE_piccoli$logRII)
educRII_male_GEE_piccoli$lower95 <- exp(educRII_male_GEE_piccoli$logRII-1.96*educRII_male_GEE_piccoli$selogrii)
educRII_male_GEE_piccoli$upper95 <- exp(educRII_male_GEE_piccoli$logRII+1.96*educRII_male_GEE_piccoli$selogrii)
```
\

Now instead, still considering male data, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction term between time and education rank.

\
```{r}
educRII_male_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                              data=piccoli_comuni_male,
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family=poisson(link="log"),
                              corstr = "ar1")
summary(educRII_male_GEE_fit2)
```
\

Point estimate of annual percentage change:

\
```{r}
(exp(coef(educRII_male_GEE_fit2)["TIME1:EDUC_RANK"])-1)*100
```
\

95\% confidence interval of annual percentage change:

\
```{r}
c((exp(coef(educRII_male_GEE_fit2)["TIME1:EDUC_RANK"]-1.96*summary(educRII_male_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2])-1)*100,
  (exp(coef(educRII_male_GEE_fit2)["TIME1:EDUC_RANK"]+1.96*summary(educRII_male_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2])-1)*100)
```
\

We now calculate the RII estimates for the rank of education in men obtained with the previous model.

\
```{r}
educRII_male_GEE_piccoli2 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educRII_male_GEE_piccoli2$TIME)){
  #logRII
  educRII_male_GEE_piccoli2$logRII[educRII_male_GEE_piccoli2$TIME==anno] <- coef(educRII_male_GEE_fit2)["EDUC_RANK"]+(anno-2011)*coef(educRII_male_GEE_fit2)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_male_GEE_piccoli2$selogrii[educRII_male_GEE_piccoli2$TIME==anno] <- sqrt(vcov(educRII_male_GEE_fit2)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_male_GEE_fit2)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_male_GEE_fit2)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_male_GEE_piccoli2$SE[educRII_male_GEE_piccoli2$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE_piccoli2$logRII[educRII_male_GEE_piccoli2$TIME==anno],
                                   educRII_male_GEE_piccoli2$selogrii[educRII_male_GEE_piccoli2$TIME==anno]^2)
}
educRII_male_GEE_piccoli2$RII <- exp(educRII_male_GEE_piccoli2$logRII)
educRII_male_GEE_piccoli2$lower95 <- exp(educRII_male_GEE_piccoli2$logRII-1.96*educRII_male_GEE_piccoli2$selogrii)
educRII_male_GEE_piccoli2$upper95 <- exp(educRII_male_GEE_piccoli2$logRII+1.96*educRII_male_GEE_piccoli2$selogrii)
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and educational rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
educRII_male_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                              data=subset(piccoli_comuni_male,TIME!=2020 & TIME!=2021 & TIME!=2022),
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family=poisson(link="log"),
                              corstr = "ar1")
summary(educRII_male_GEE_fit3)
```
\

Point estimate of annual percentage change:

\
```{r}
(exp(coef(educRII_male_GEE_fit3)["TIME1:EDUC_RANK"])-1)*100
```
\

95\% confidence interval of annual percentage change:

\
```{r}
c((exp(coef(educRII_male_GEE_fit3)["TIME1:EDUC_RANK"]-1.96*summary(educRII_male_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2])-1)*100,
  (exp(coef(educRII_male_GEE_fit3)["TIME1:EDUC_RANK"]+1.96*summary(educRII_male_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2])-1)*100)
```
\

Ora calcoliamo le stime del RII relative al rango dell'istruzione negli uomini ottenute con il precedente modello.

\
```{r}
educRII_male_GEE_piccoli3 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educRII_male_GEE_piccoli3$TIME)){
  #logRII
  educRII_male_GEE_piccoli3$logRII[educRII_male_GEE_piccoli3$TIME==anno] <- coef(educRII_male_GEE_fit3)["EDUC_RANK"]+(anno-2011)*coef(educRII_male_GEE_fit3)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_male_GEE_piccoli3$selogrii[educRII_male_GEE_piccoli3$TIME==anno] <- sqrt(vcov(educRII_male_GEE_fit3)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_male_GEE_fit3)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_male_GEE_fit3)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_male_GEE_piccoli3$SE[educRII_male_GEE_piccoli3$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_male_GEE_piccoli3$logRII[educRII_male_GEE_piccoli3$TIME==anno],
                                   educRII_male_GEE_piccoli3$selogrii[educRII_male_GEE_piccoli3$TIME==anno]^2)
}
educRII_male_GEE_piccoli3$RII <- exp(educRII_male_GEE_piccoli3$logRII)
educRII_male_GEE_piccoli3$lower95 <- exp(educRII_male_GEE_piccoli3$logRII-1.96*educRII_male_GEE_piccoli3$selogrii)
educRII_male_GEE_piccoli3$upper95 <- exp(educRII_male_GEE_piccoli3$logRII+1.96*educRII_male_GEE_piccoli3$selogrii)
```
\

#### Income

At this point, considering the data for the male gender, we fit a model to calculate the RII relative to income rank, in which the time variable is considered as a categorical variable.

\
```{r}
incomeRII_male_GEE_fit1<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+
                                  factor(TIME)+INCOME_RANK+INCOME_RANK:factor(TIME),
                               data = piccoli_comuni_male, 
                               id = interaction(ITTER107,factor(AgeGroup)),
                               family = poisson(link = "log"), 
                               corstr = "ar1")
summary(incomeRII_male_GEE_fit1)
```
\

We now attempt to derive the RII estimates for the income rank in men in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
incomeRII_male_GEE_piccoli <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(complete_df$TIME))
# RII calculation
male_income_coef <- summary(incomeRII_male_GEE_fit1)$coefficients[22:33,1:2]
male_income_vcov <- vcov(incomeRII_male_GEE_fit1)[22:33,22:33]
for(anno in unique(incomeRII_male_GEE_piccoli$TIME)){
  if(anno==2011){
    #logRII
    incomeRII_male_GEE_piccoli$logRII[incomeRII_male_GEE_piccoli$TIME==anno] <- male_income_coef[1,1]
    #SE of log(RII)
    incomeRII_male_GEE_piccoli$selogrii[incomeRII_male_GEE_piccoli$TIME==anno] <- sqrt(male_income_vcov[1,1])
    #SE of RII
    incomeRII_male_GEE_piccoli$SE[incomeRII_male_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE_piccoli$logRII[incomeRII_male_GEE_piccoli$TIME==anno],
                                   incomeRII_male_GEE_piccoli$selogrii[incomeRII_male_GEE_piccoli$TIME==anno]^2)
    }
  else{
    #logRII
    incomeRII_male_GEE_piccoli$logRII[incomeRII_male_GEE_piccoli$TIME==anno] <- male_income_coef[1,1]+male_income_coef[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),1]
    #SE of log(RII)
    incomeRII_male_GEE_piccoli$selogrii[incomeRII_male_GEE_piccoli$TIME==anno] <- sqrt(male_income_vcov[1,1]+male_income_vcov[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),paste0("factor(TIME)",as.character(anno),":INCOME_RANK")]+2*male_income_vcov[1,paste0("factor(TIME)",as.character(anno),":INCOME_RANK")])
    #SE of RII
    incomeRII_male_GEE_piccoli$SE[incomeRII_male_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE_piccoli$logRII[incomeRII_male_GEE_piccoli$TIME==anno],
                                   incomeRII_male_GEE_piccoli$selogrii[incomeRII_male_GEE_piccoli$TIME==anno]^2)
  }
}
incomeRII_male_GEE_piccoli$RII <- exp(incomeRII_male_GEE_piccoli$logRII)
incomeRII_male_GEE_piccoli$lower95 <- exp(incomeRII_male_GEE_piccoli$logRII-1.96*incomeRII_male_GEE_piccoli$selogrii)
incomeRII_male_GEE_piccoli$upper95 <- exp(incomeRII_male_GEE_piccoli$logRII+1.96*incomeRII_male_GEE_piccoli$selogrii)
```
\

Now instead we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank.

\
```{r}
incomeRII_male_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                            data=piccoli_comuni_male,
                            id = interaction(ITTER107,factor(AgeGroup)),
                            family=poisson(link="log"),
                            corstr = "ar1")
summary(incomeRII_male_GEE_fit2)
```
\

Point estimate of annual percentage change:

\
```{r}
(exp(coef(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK"])-1)*100
```
\

95\% confidence interval of the interaction term:

\
```{r}
c((exp(coef(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_male_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2])-1)*100,
  (exp(coef(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_male_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2])-1)*100)
```
\

We now calculate the estimates of RII related to income rank in men obtained with the previous model.

\
```{r}
incomeRII_male_GEE_piccoli2 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeRII_male_GEE_piccoli2$TIME)){
  #logRII
  incomeRII_male_GEE_piccoli2$logRII[incomeRII_male_GEE_piccoli2$TIME==anno] <- coef(incomeRII_male_GEE_fit2)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_male_GEE_piccoli2$selogrii[incomeRII_male_GEE_piccoli2$TIME==anno] <- sqrt(vcov(incomeRII_male_GEE_fit2)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_male_GEE_fit2)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_male_GEE_fit2)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_male_GEE_piccoli2$SE[incomeRII_male_GEE_piccoli2$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE_piccoli2$logRII[incomeRII_male_GEE_piccoli2$TIME==anno],
                                   incomeRII_male_GEE_piccoli2$selogrii[incomeRII_male_GEE_piccoli2$TIME==anno]^2)
}
incomeRII_male_GEE_piccoli2$RII <- exp(incomeRII_male_GEE_piccoli2$logRII)
incomeRII_male_GEE_piccoli2$lower95 <- exp(incomeRII_male_GEE_piccoli2$logRII-1.96*incomeRII_male_GEE_piccoli2$selogrii)
incomeRII_male_GEE_piccoli2$upper95 <- exp(incomeRII_male_GEE_piccoli2$logRII+1.96*incomeRII_male_GEE_piccoli2$selogrii)
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeRII_male_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                                data=subset(piccoli_comuni_male,TIME!=2020 & TIME!=2021 & TIME!=2022),
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(incomeRII_male_GEE_fit3)
```
\

Point estimate of the annual percentage change:

\
```{r}
(exp(coef(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK"])-1)*100
```
\

95\% confidence interval of the annual percentage change:

\
```{r}
c((exp(coef(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_male_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2])-1)*100,
  (exp(coef(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_male_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2])-1)*100)
```
\

We now calculate the estimates of RII related to income rank in men obtained with the previous model.

\
```{r}
incomeRII_male_GEE_piccoli3 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeRII_male_GEE_piccoli3$TIME)){
  #logRII
  incomeRII_male_GEE_piccoli3$logRII[incomeRII_male_GEE_piccoli3$TIME==anno] <- coef(incomeRII_male_GEE_fit3)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_male_GEE_piccoli3$selogrii[incomeRII_male_GEE_piccoli3$TIME==anno] <- sqrt(vcov(incomeRII_male_GEE_fit3)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_male_GEE_fit3)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_male_GEE_fit3)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_male_GEE_piccoli3$SE[incomeRII_male_GEE_piccoli3$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_male_GEE_piccoli3$logRII[incomeRII_male_GEE_piccoli3$TIME==anno],
                                   incomeRII_male_GEE_piccoli3$selogrii[incomeRII_male_GEE_piccoli3$TIME==anno]^2)
}
incomeRII_male_GEE_piccoli3$RII <- exp(incomeRII_male_GEE_piccoli3$logRII)
incomeRII_male_GEE_piccoli3$lower95 <- exp(incomeRII_male_GEE_piccoli3$logRII-1.96*incomeRII_male_GEE_piccoli3$selogrii)
incomeRII_male_GEE_piccoli3$upper95 <- exp(incomeRII_male_GEE_piccoli3$logRII+1.96*incomeRII_male_GEE_piccoli3$selogrii)
```
\

### Women

#### Education

Secondly, we repeat the previous analysis considering the data for the female gender.

\
```{r}
educRII_female_GEE_fit1<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+
                                  factor(TIME)+EDUC_RANK+EDUC_RANK:factor(TIME),
                                data=piccoli_comuni_female,
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(educRII_female_GEE_fit1)
```
\

We now try to derive the RII estimates for the educational rank in women in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
educRII_female_GEE_piccoli <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(complete_df$TIME))
# RII calculation
female_educ_coef <- summary(educRII_female_GEE_fit1)$coefficients[22:33,1:2]
female_educ_vcov <- vcov(educRII_female_GEE_fit1)[22:33,22:33]
for(anno in unique(educRII_female_GEE_piccoli$TIME)){
  if(anno==2011){
    #logRII
    educRII_female_GEE_piccoli$logRII[educRII_female_GEE_piccoli$TIME==anno] <- female_educ_coef[1,1]
    #SE of log(RII)
    educRII_female_GEE_piccoli$selogrii[educRII_female_GEE_piccoli$TIME==anno] <- sqrt(female_educ_vcov[1,1])
    #SE of RII
    educRII_female_GEE_piccoli$SE[educRII_female_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE_piccoli$logRII[educRII_female_GEE_piccoli$TIME==anno],
                                   educRII_female_GEE_piccoli$selogrii[educRII_female_GEE_piccoli$TIME==anno]^2)
    }
  else{
    #logRII
    educRII_female_GEE_piccoli$logRII[educRII_female_GEE_piccoli$TIME==anno] <- female_educ_coef[1,1]+female_educ_coef[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),1]
    #SE of log(RII)
    educRII_female_GEE_piccoli$selogrii[educRII_female_GEE_piccoli$TIME==anno] <- sqrt(female_educ_vcov[1,1]+female_educ_vcov[paste0("factor(TIME)",as.character(anno),":EDUC_RANK"),paste0("factor(TIME)",as.character(anno),":EDUC_RANK")]+2*female_educ_vcov[1,paste0("factor(TIME)",as.character(anno),":EDUC_RANK")])
    #SE of RII
    educRII_female_GEE_piccoli$SE[educRII_female_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE_piccoli$logRII[educRII_female_GEE_piccoli$TIME==anno],
                                   educRII_female_GEE_piccoli$selogrii[educRII_female_GEE_piccoli$TIME==anno]^2)
  }
}
educRII_female_GEE_piccoli$RII <- exp(educRII_female_GEE_piccoli$logRII)
educRII_female_GEE_piccoli$lower95 <- exp(educRII_female_GEE_piccoli$logRII-1.96*educRII_female_GEE_piccoli$selogrii)
educRII_female_GEE_piccoli$upper95 <- exp(educRII_female_GEE_piccoli$logRII+1.96*educRII_female_GEE_piccoli$selogrii)
```
\

Now we fit a new model in which I consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and education rank.

\
```{r}
educRII_female_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                                data=piccoli_comuni_female,
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family=poisson(link="log"),
                                corstr = "ar1")
summary(educRII_female_GEE_fit2)
```
\

Point estimate of the annual percentage change:

\
```{r}
(exp(coef(educRII_female_GEE_fit2)["TIME1:EDUC_RANK"])-1)*100
```
\

95\% confidence interval of the interaction term:

\
```{r}
c((exp(coef(educRII_female_GEE_fit2)["TIME1:EDUC_RANK"]-1.96*summary(educRII_female_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2])-1)*100,
  (exp(coef(educRII_female_GEE_fit2)["TIME1:EDUC_RANK"]+1.96*summary(educRII_female_GEE_fit2)$coefficients["TIME1:EDUC_RANK",2])-1)*100)
```
\

We now calculate the RII estimates for the educational rank in women obtained with the previous model.

\
```{r}
educRII_female_GEE_piccoli2 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educRII_female_GEE_piccoli2$TIME)){
  #logRII
  educRII_female_GEE_piccoli2$logRII[educRII_female_GEE_piccoli2$TIME==anno] <- coef(educRII_female_GEE_fit2)["EDUC_RANK"]+(anno-2011)*coef(educRII_female_GEE_fit2)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_female_GEE_piccoli2$selogrii[educRII_female_GEE_piccoli2$TIME==anno] <- sqrt(vcov(educRII_female_GEE_fit2)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_female_GEE_fit2)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_female_GEE_fit2)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_female_GEE_piccoli2$SE[educRII_female_GEE_piccoli2$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE_piccoli2$logRII[educRII_female_GEE_piccoli2$TIME==anno],
                                   educRII_female_GEE_piccoli2$selogrii[educRII_female_GEE_piccoli2$TIME==anno]^2)
}
educRII_female_GEE_piccoli2$RII <- exp(educRII_female_GEE_piccoli2$logRII)
educRII_female_GEE_piccoli2$lower95 <- exp(educRII_female_GEE_piccoli2$logRII-1.96*educRII_female_GEE_piccoli2$selogrii)
educRII_female_GEE_piccoli2$upper95 <- exp(educRII_female_GEE_piccoli2$logRII+1.96*educRII_female_GEE_piccoli2$selogrii)
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and educational rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
educRII_female_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+EDUC_RANK+EDUC_RANK:TIME1,
                            data=subset(piccoli_comuni_female,TIME!=2020 & TIME!=2021 & TIME!=2022),
                            id = interaction(ITTER107,factor(AgeGroup)),
                            family=poisson(link="log"),
                            corstr = "ar1")
summary(educRII_female_GEE_fit3)
```
\

Point estimate of the annual percentage

\
```{r}
(exp(coef(educRII_female_GEE_fit3)["TIME1:EDUC_RANK"])-1)*100
```
\

95\% confidence interval of the annual percentage change:

\
```{r}
c((exp(coef(educRII_female_GEE_fit3)["TIME1:EDUC_RANK"]-1.96*summary(educRII_female_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2])-1)*100,
  (exp(coef(educRII_female_GEE_fit3)["TIME1:EDUC_RANK"]+1.96*summary(educRII_female_GEE_fit3)$coefficients["TIME1:EDUC_RANK",2])-1)*100)
```
\

We now calculate the IBR estimates for the rank of education in women obtained with the previous model.

\
```{r}
educRII_female_GEE_piccoli3 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educRII_female_GEE_piccoli3$TIME)){
  #logRII
  educRII_female_GEE_piccoli3$logRII[educRII_female_GEE_piccoli3$TIME==anno] <- coef(educRII_female_GEE_fit3)["EDUC_RANK"]+(anno-2011)*coef(educRII_female_GEE_fit3)["TIME1:EDUC_RANK"]
  #SE of logRII
  educRII_female_GEE_piccoli3$selogrii[educRII_female_GEE_piccoli3$TIME==anno] <- sqrt(vcov(educRII_female_GEE_fit3)["EDUC_RANK","EDUC_RANK"] +(anno-2011)^2*vcov(educRII_female_GEE_fit3)["TIME1:EDUC_RANK","TIME1:EDUC_RANK"]+2*(anno-2011)*vcov(educRII_female_GEE_fit3)["EDUC_RANK","TIME1:EDUC_RANK"])
  #SE of RII
  educRII_female_GEE_piccoli3$SE[educRII_female_GEE_piccoli3$TIME==anno] <- deltamethod(~exp(x1),
                                   educRII_female_GEE_piccoli3$logRII[educRII_female_GEE_piccoli3$TIME==anno],
                                   educRII_female_GEE_piccoli3$selogrii[educRII_female_GEE_piccoli3$TIME==anno]^2)
}
educRII_female_GEE_piccoli3$RII <- exp(educRII_female_GEE_piccoli3$logRII)
educRII_female_GEE_piccoli3$lower95 <- exp(educRII_female_GEE_piccoli3$logRII-1.96*educRII_female_GEE_piccoli3$selogrii)
educRII_female_GEE_piccoli3$upper95 <- exp(educRII_female_GEE_piccoli3$logRII+1.96*educRII_female_GEE_piccoli3$selogrii)
```
\

#### Income

At this point, considering the data for the female gender, we fit a model to calculate the RII relative to income rank, in which the time variable is considered as a categorical variable.

\
```{r}
incomeRII_female_GEE_fit1<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+
                                    factor(TIME)+INCOME_RANK+INCOME_RANK:factor(TIME),
                                  data=piccoli_comuni_female,
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family=poisson(link="log"),
                                  corstr = "ar1")
summary(incomeRII_female_GEE_fit1)
```
\

We now attempt to derive the IBR estimates for the educational rank in women in each year of the observation period by calculating point estimates and corresponding standard errors for the calculation of confidence intervals with a significance level of 0.05.

\
```{r}
incomeRII_female_GEE_piccoli <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(complete_df$TIME))
# RII calculation
female_income_coef <- summary(incomeRII_female_GEE_fit1)$coefficients[22:33,1:2]
female_income_vcov <- vcov(incomeRII_female_GEE_fit1)[22:33,22:33]
for(anno in unique(incomeRII_female_GEE_piccoli$TIME)){
  if(anno==2011){
    #logRII
    incomeRII_female_GEE_piccoli$logRII[incomeRII_female_GEE_piccoli$TIME==anno] <- female_income_coef[1,1]
    #SE of log(RII)
    incomeRII_female_GEE_piccoli$selogrii[incomeRII_female_GEE_piccoli$TIME==anno] <- sqrt(female_income_vcov[1,1])
    #SE of RII
    incomeRII_female_GEE_piccoli$SE[incomeRII_female_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE_piccoli$logRII[incomeRII_female_GEE_piccoli$TIME==anno],
                                   incomeRII_female_GEE_piccoli$selogrii[incomeRII_female_GEE_piccoli$TIME==anno]^2)
    }
  else{
    #logRII
    incomeRII_female_GEE_piccoli$logRII[incomeRII_female_GEE_piccoli$TIME==anno] <- female_income_coef[1,1]+female_income_coef[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),1]
    #SE of log(RII)
    incomeRII_female_GEE_piccoli$selogrii[incomeRII_female_GEE_piccoli$TIME==anno] <- sqrt(female_income_vcov[1,1]+female_income_vcov[paste0("factor(TIME)",as.character(anno),":INCOME_RANK"),paste0("factor(TIME)",as.character(anno),":INCOME_RANK")]+2*female_income_vcov[1,paste0("factor(TIME)",as.character(anno),":INCOME_RANK")])
    #SE of RII
    incomeRII_female_GEE_piccoli$SE[incomeRII_female_GEE_piccoli$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE_piccoli$logRII[incomeRII_female_GEE_piccoli$TIME==anno],
                                   incomeRII_female_GEE_piccoli$selogrii[incomeRII_female_GEE_piccoli$TIME==anno]^2)
  }
}
incomeRII_female_GEE_piccoli$RII <- exp(incomeRII_female_GEE_piccoli$logRII)
incomeRII_female_GEE_piccoli$lower95 <- exp(incomeRII_female_GEE_piccoli$logRII-1.96*incomeRII_female_GEE_piccoli$selogrii)
incomeRII_female_GEE_piccoli$upper95 <- exp(incomeRII_female_GEE_piccoli$logRII+1.96*incomeRII_female_GEE_piccoli$selogrii)
```
\

Now we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank.

\
```{r}
incomeRII_female_GEE_fit2<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                                  data=piccoli_comuni_female,
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family=poisson(link="log"),
                                  corstr = "ar1")
summary(incomeRII_female_GEE_fit2)
```
\

Point estimate of the annula percentage change:

\
```{r}
(exp(coef(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK"])-1)*100
```
\

95\% confidence interval of the annual percentage change:

\
```{r}
c((exp(coef(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_female_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2])-1)*100,
  (exp(coef(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_female_GEE_fit2)$coefficients["TIME1:INCOME_RANK",2])-1)*100)
```
\

We now calculate the estimates of RII related to income rank in women obtained with the previous model.

\
```{r}
incomeRII_female_GEE_piccoli2 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeRII_female_GEE_piccoli2$TIME)){
  #logRII
  incomeRII_female_GEE_piccoli2$logRII[incomeRII_female_GEE_piccoli2$TIME==anno] <- coef(incomeRII_female_GEE_fit2)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_female_GEE_piccoli2$selogrii[incomeRII_female_GEE_piccoli2$TIME==anno] <- sqrt(vcov(incomeRII_female_GEE_fit2)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_female_GEE_fit2)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_female_GEE_fit2)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_female_GEE_piccoli2$SE[incomeRII_female_GEE_piccoli2$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE_piccoli2$logRII[incomeRII_female_GEE_piccoli2$TIME==anno],
                                   incomeRII_female_GEE_piccoli2$selogrii[incomeRII_female_GEE_piccoli2$TIME==anno]^2)
}
incomeRII_female_GEE_piccoli2$RII <- exp(incomeRII_female_GEE_piccoli2$logRII)
incomeRII_female_GEE_piccoli2$lower95 <- exp(incomeRII_female_GEE_piccoli2$logRII-1.96*incomeRII_female_GEE_piccoli2$selogrii)
incomeRII_female_GEE_piccoli2$upper95 <- exp(incomeRII_female_GEE_piccoli2$logRII+1.96*incomeRII_female_GEE_piccoli2$selogrii)
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and educational rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeRII_female_GEE_fit3<-geeglm(Decessi~offset(log(pop_media))+factor(AgeGroup)+TIME1+INCOME_RANK+INCOME_RANK:TIME1,
                                  data=subset(piccoli_comuni_female,TIME!=2020 & TIME!=2021 & TIME!=2022),
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family=poisson(link="log"),
                                  corstr = "ar1")
summary(incomeRII_female_GEE_fit3)
```
\

Point estimate of the annual percentage change:

\
```{r}
(exp(coef(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK"])-1)*100
```
\

95\% confidence interval of the annual percentage change:

\
```{r}
c((exp(coef(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK"]-1.96*summary(incomeRII_female_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2])-1)*100,
  (exp(coef(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK"]+1.96*summary(incomeRII_female_GEE_fit3)$coefficients["TIME1:INCOME_RANK",2])-1)*100)
```
\

We now calculate the estimates of RII related to income rank in women obtained with the previous model.

\
```{r}
incomeRII_female_GEE_piccoli3 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeRII_female_GEE_piccoli3$TIME)){
  #logRII
  incomeRII_female_GEE_piccoli3$logRII[incomeRII_female_GEE_piccoli3$TIME==anno] <- coef(incomeRII_female_GEE_fit3)["INCOME_RANK"]+(anno-2011)*coef(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK"]
  #SE of logRII
  incomeRII_female_GEE_piccoli3$selogrii[incomeRII_female_GEE_piccoli3$TIME==anno] <- sqrt(vcov(incomeRII_female_GEE_fit3)["INCOME_RANK","INCOME_RANK"] +(anno-2011)^2*vcov(incomeRII_female_GEE_fit3)["TIME1:INCOME_RANK","TIME1:INCOME_RANK"]+2*(anno-2011)*vcov(incomeRII_female_GEE_fit3)["INCOME_RANK","TIME1:INCOME_RANK"])
  #SE of RII
  incomeRII_female_GEE_piccoli3$SE[incomeRII_female_GEE_piccoli3$TIME==anno] <- deltamethod(~exp(x1),
                                   incomeRII_female_GEE_piccoli3$logRII[incomeRII_female_GEE_piccoli3$TIME==anno],
                                   incomeRII_female_GEE_piccoli3$selogrii[incomeRII_female_GEE_piccoli3$TIME==anno]^2)
}
incomeRII_female_GEE_piccoli3$RII <- exp(incomeRII_female_GEE_piccoli3$logRII)
incomeRII_female_GEE_piccoli3$lower95 <- exp(incomeRII_female_GEE_piccoli3$logRII-1.96*incomeRII_female_GEE_piccoli3$selogrii)
incomeRII_female_GEE_piccoli3$upper95 <- exp(incomeRII_female_GEE_piccoli3$logRII+1.96*incomeRII_female_GEE_piccoli3$selogrii)
```
\

We create the dataset in which we save the point and interval estimates of the RII for the educatioanal rank and the income rank, for both men and women, in the period between 2011 and 2022 in small municipalities obtained from the models in which the time variable is considered as a categorical variable.

\
```{r}
options(digits = 5)
RII_GEE_2011_2022_piccoli <- rbind(educRII_male_GEE_piccoli,educRII_female_GEE_piccoli,
                                   incomeRII_male_GEE_piccoli,incomeRII_female_GEE_piccoli)
RII_GEE_2011_2022_piccoli$SESSO <- factor(RII_GEE_2011_2022_piccoli$SESSO,levels = c(1,2),labels = c("Male","Female"))
RII_GEE_2011_2022_piccoli <- RII_GEE_2011_2022_piccoli[order(RII_GEE_2011_2022_piccoli$VAR,RII_GEE_2011_2022_piccoli$SESSO,RII_GEE_2011_2022_piccoli$TIME),]
save(RII_GEE_2011_2022_piccoli,file="RII_GEE_2011_2022_piccoli.Rdata")
```
\

We create an additional dataset in which the point estimates of RII for educational rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the models, in which the time variable is regarded as a continuous variable, are saved.

\
```{r}
options(digits = 5)
predRII_GEE_2011_2022_piccoli <- rbind(educRII_male_GEE_piccoli2,
                                       educRII_female_GEE_piccoli2,
                                       incomeRII_male_GEE_piccoli2,
                                       incomeRII_female_GEE_piccoli2)
predRII_GEE_2011_2022_piccoli$SESSO <- factor(predRII_GEE_2011_2022_piccoli$SESSO,
                                              levels = c(1,2),
                                              labels = c("Male","Female"))
predRII_GEE_2011_2022_piccoli <- predRII_GEE_2011_2022_piccoli[order(predRII_GEE_2011_2022_piccoli$VAR,
                                                                     predRII_GEE_2011_2022_piccoli$SESSO,
                                                                     predRII_GEE_2011_2022_piccoli$TIME),]
save(predRII_GEE_2011_2022_piccoli,file="predRII_GEE_2011_2022_piccoli.Rdata")
load("predRII_GEE_2011_2022_piccoli.Rdata")
```
\

I create a third dataset in which to save the point estimates of the RII for education rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the models in which the time variable is considered as a continuous variable and in which the calendar years 2020, 2021 e 2022 are not considered.

\
```{r}
options(digits = 5)
predRII_GEE_precovid_piccoli <- rbind(educRII_male_GEE_piccoli3,
                                      educRII_female_GEE_piccoli3,
                                      incomeRII_male_GEE_piccoli3,
                                      incomeRII_female_GEE_piccoli3)
predRII_GEE_precovid_piccoli$SESSO <- factor(predRII_GEE_precovid_piccoli$SESSO,
                                             levels = c(1,2),labels = c("Male","Female"))
predRII_GEE_precovid_piccoli <- predRII_GEE_precovid_piccoli[order(predRII_GEE_precovid_piccoli$VAR,
                                                                   predRII_GEE_precovid_piccoli$SESSO,
                                                                   predRII_GEE_precovid_piccoli$TIME),]
save(predRII_GEE_precovid_piccoli,file="predRII_GEE_precovid_piccoli.Rdata")
```
\

## SII

I now implement the models for calculating the IIS for education rank (EDUC_RANK) and income rank (INCOME_RANK) over the time period 2011 to 2022. we implement separate models for male and female gender.


NB: The following models were implemented using SAS software due to convergence problems. The equivalent codes in R language are presented. The coefficient estimates obtained in SAS are loaded into R and thus the indicators are estimated.

### Men

#### Education

We implement the models for calculating the SII relative to the educational rank among men where the time variable is categorical.

\
```{r}
educSII_male_GEE_fit1 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK):factor(TIME)-1,
                               data=piccoli_comuni_male, 
                               id = interaction(ITTER107,factor(AgeGroup)),
                               family = poisson(link = "identity"), 
                               corstr = "ar1")
summary(educSII_male_GEE_fit1)
```
\

SII estimates of the eduactional rank in men.

\
```{r}
educSII_male_GEE_piccoli_SAS <- read.csv("educSII_male_GEE_piccoli.csv")
educSII_male_GEE_piccoli_SAS <- educSII_male_GEE_piccoli_SAS[-1,]
educSII_male_GEE_piccoli <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(complete_df$TIME))
for(anno in unique(educSII_male_GEE_piccoli$TIME)){
  #SII
  educSII_male_GEE_piccoli$SII[educSII_male_GEE_piccoli$TIME==anno] <- educSII_male_GEE_piccoli_SAS$Estimate[educSII_male_GEE_piccoli_SAS$Level1==anno]
  #SE
  educSII_male_GEE_piccoli$SE[educSII_male_GEE_piccoli$TIME==anno] <- educSII_male_GEE_piccoli_SAS$Stderr[educSII_male_GEE_piccoli_SAS$Level1==anno]
  #lower95
  educSII_male_GEE_piccoli$lower95[educSII_male_GEE_piccoli$TIME==anno] <- educSII_male_GEE_piccoli_SAS$LowerCL[educSII_male_GEE_piccoli_SAS$Level1==anno]
  #upper95
  #SII
  educSII_male_GEE_piccoli$upper95[educSII_male_GEE_piccoli$TIME==anno] <- educSII_male_GEE_piccoli_SAS$UpperCL[educSII_male_GEE_piccoli_SAS$Level1==anno]
}
```
\

We now implement a second model in which we treat the time variable as a continuous variable and consider the whole observation period.

\
```{r}
educSII_male_GEE_fit2 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                         data=piccoli_comuni_male, 
                         id = interaction(ITTER107,factor(AgeGroup)),
                         family = poisson(link = "identity"), 
                         corstr = "ar1")
summary(educSII_male_GEE_fit2)
```
\

We calculate the point estimate of the annual change of SII.

\
```{r}
educSII_male_GEE_piccoli_SAS2 <- read.csv("educSII_male_GEE_piccoli2.csv")
educSII_male_GEE_piccoli_vcov2 <- read.csv("educSII_male_GEE_piccoli_vcov2.csv")

educSII_male_GEE_piccoli_SAS2$Estimate[educSII_male_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]
```
\

95\% confidence interval of the annual change of SII.

\
```{r}
c(educSII_male_GEE_piccoli_SAS2$Estimate[educSII_male_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]-1.96*educSII_male_GEE_piccoli_SAS2$Stderr[educSII_male_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"],
  educSII_male_GEE_piccoli_SAS2$Estimate[educSII_male_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]+1.96*educSII_male_GEE_piccoli_SAS2$Stderr[educSII_male_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"])
```
\

We now calculate the SII estimates of the educational rank in men obtained with the previous model.

\
```{r}
educSII_male_GEE_piccoli2 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educSII_male_GEE_piccoli2$TIME)){
  #SII
  educSII_male_GEE_piccoli2$SII[educSII_male_GEE_piccoli2$TIME==anno] <- educSII_male_GEE_piccoli_SAS2$Estimate[educSII_male_GEE_piccoli_SAS2$Parm=="pop_media*EDUC_RANK"]+(anno-2011)*educSII_male_GEE_piccoli_SAS2$Estimate[educSII_male_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]
  #SE of SII
  educSII_male_GEE_piccoli2$SE[educSII_male_GEE_piccoli2$TIME==anno] <- sqrt(educSII_male_GEE_piccoli_vcov2[11,12]+(anno-2011)^2*educSII_male_GEE_piccoli_vcov2[12,13]+2*(anno-2011)*educSII_male_GEE_piccoli_vcov2[11,13])
}
educSII_male_GEE_piccoli2$lower95 <- educSII_male_GEE_piccoli2$SII-1.96*educSII_male_GEE_piccoli2$SE
educSII_male_GEE_piccoli2$upper95 <- educSII_male_GEE_piccoli2$SII+1.96*educSII_male_GEE_piccoli2$SE
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and educational rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
educSII_male_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                              data=subset(piccoli_comuni_male,
                                          TIME!=2020 & TIME!=2021 & TIME!=2022), 
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family = poisson(link = "identity"), 
                              corstr = "ar1")
summary(educSII_male_GEE_fit3)
```
\

Point estimate of the annual change of SII.

\
```{r}
educSII_male_GEE_piccoli_SAS3 <- read.csv("educSII_male_GEE_piccoli3.csv")
educSII_male_GEE_piccoli_vcov3 <- read.csv("educSII_male_GEE_piccoli_vcov3.csv")

educSII_male_GEE_piccoli_SAS3$Estimate[educSII_male_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"]
```
\

95\% confidence interval of annual change of SII.

\
```{r}
c(educSII_male_GEE_piccoli_SAS3$Estimate[educSII_male_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"]-1.96*educSII_male_GEE_piccoli_SAS3$Stderr[educSII_male_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"],
  educSII_male_GEE_piccoli_SAS3$Estimate[educSII_male_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"]+1.96*educSII_male_GEE_piccoli_SAS3$Stderr[educSII_male_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"])
```
\

We now calculate the IBS estimates of the eduactional rank in men obtained with the previous model.

\
```{r}
educSII_male_GEE_piccoli3 <- expand.grid(VAR="EDUC",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(educSII_male_GEE_piccoli3$TIME)){
  #SII
  educSII_male_GEE_piccoli3$SII[educSII_male_GEE_piccoli3$TIME==anno] <- educSII_male_GEE_piccoli_SAS3$Estimate[educSII_male_GEE_piccoli_SAS3$Parm=="pop_media*EDUC_RANK"]+(anno-2011)*educSII_male_GEE_piccoli_SAS3$Estimate[educSII_male_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"]
  #SE of SII
  educSII_male_GEE_piccoli3$SE[educSII_male_GEE_piccoli3$TIME==anno] <- sqrt(educSII_male_GEE_piccoli_vcov3[11,12]+(anno-2011)^2*educSII_male_GEE_piccoli_vcov3[12,13]+2*(anno-2011)*educSII_male_GEE_piccoli_vcov3[11,13])
}
educSII_male_GEE_piccoli3$lower95 <- educSII_male_GEE_piccoli3$SII-1.96*educSII_male_GEE_piccoli3$SE
educSII_male_GEE_piccoli3$upper95 <- educSII_male_GEE_piccoli3$SII+1.96*educSII_male_GEE_piccoli3$SE
```
\

#### Income

At this point, the previous analyses are repeated for the calculation of the SII related to income rank in men over the observation period.

\
```{r}
incomeSII_male_GEE_fit1 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK):factor(TIME)-1,
                                 data=piccoli_comuni_male, 
                                 id = interaction(ITTER107,factor(AgeGroup)),
                                 family = poisson(link = "identity"), 
                                 corstr = "ar1")
summary(incomeSII_male_GEE_fit1)
```
\

SII estimate related to income rank in men.

\
```{r}
incomeSII_male_GEE_piccoli_SAS <- read.csv("incomeSII_male_GEE_piccoli.csv")
incomeSII_male_GEE_piccoli_SAS <- incomeSII_male_GEE_piccoli_SAS[-1,]
incomeSII_male_GEE_piccoli <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(complete_df$TIME))
for(anno in unique(incomeSII_male_GEE_piccoli$TIME)){
  #SII
  incomeSII_male_GEE_piccoli$SII[incomeSII_male_GEE_piccoli$TIME==anno] <- incomeSII_male_GEE_piccoli_SAS$Estimate[incomeSII_male_GEE_piccoli_SAS$Level1==anno]
  #SE
  incomeSII_male_GEE_piccoli$SE[incomeSII_male_GEE_piccoli$TIME==anno] <- incomeSII_male_GEE_piccoli_SAS$Stderr[incomeSII_male_GEE_piccoli_SAS$Level1==anno]
  #lower95
  incomeSII_male_GEE_piccoli$lower95[incomeSII_male_GEE_piccoli$TIME==anno] <- incomeSII_male_GEE_piccoli_SAS$LowerCL[incomeSII_male_GEE_piccoli_SAS$Level1==anno]
  #upper95
  #SII
  incomeSII_male_GEE_piccoli$upper95[incomeSII_male_GEE_piccoli$TIME==anno] <- incomeSII_male_GEE_piccoli_SAS$UpperCL[incomeSII_male_GEE_piccoli_SAS$Level1==anno]
}
```
\

Now we implement a second model in which we treat the time variable as a continuous variable and consider the entire observation period.

\
```{r}
incomeSII_male_GEE_fit2 <- geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                              data=piccoli_comuni_male, 
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family = poisson(link = "identity"), 
                              corstr = "ar1")
summary(incomeSII_male_GEE_fit2)
```
\

Point estimate of annual change of SII.

\
```{r}
incomeSII_male_GEE_piccoli_SAS2 <- read.csv("incomeSII_male_GEE_piccoli2.csv")
incomeSII_male_GEE_piccoli_vcov2 <- read.csv("incomeSII_male_GEE_piccoli_vcov2.csv")

incomeSII_male_GEE_piccoli_SAS2$Estimate[incomeSII_male_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"]
```
\

95\% confidence interval of annual change of SII.

\
```{r}
c(incomeSII_male_GEE_piccoli_SAS2$Estimate[incomeSII_male_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"]-1.96*incomeSII_male_GEE_piccoli_SAS2$Stderr[incomeSII_male_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"],
  incomeSII_male_GEE_piccoli_SAS2$Estimate[incomeSII_male_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"]+1.96*incomeSII_male_GEE_piccoli_SAS2$Stderr[incomeSII_male_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"])
```
\

We now calculate the SII estimates of income rank in men obtained with the previous model.

\
```{r}
incomeSII_male_GEE_piccoli2 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeSII_male_GEE_piccoli2$TIME)){
  #SII
  incomeSII_male_GEE_piccoli2$SII[incomeSII_male_GEE_piccoli2$TIME==anno] <- incomeSII_male_GEE_piccoli_SAS2$Estimate[incomeSII_male_GEE_piccoli_SAS2$Parm=="pop_media*INCOME_RAN"]+(anno-2011)*incomeSII_male_GEE_piccoli_SAS2$Estimate[incomeSII_male_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"]
  #SE of SII
  incomeSII_male_GEE_piccoli2$SE[incomeSII_male_GEE_piccoli2$TIME==anno] <- sqrt(incomeSII_male_GEE_piccoli_vcov2[11,12]+(anno-2011)^2*incomeSII_male_GEE_piccoli_vcov2[12,13]+2*(anno-2011)*incomeSII_male_GEE_piccoli_vcov2[11,13])
}
incomeSII_male_GEE_piccoli2$lower95 <- incomeSII_male_GEE_piccoli2$SII-1.96*incomeSII_male_GEE_piccoli2$SE
incomeSII_male_GEE_piccoli2$upper95 <- incomeSII_male_GEE_piccoli2$SII+1.96*incomeSII_male_GEE_piccoli2$SE
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeSII_male_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                                data=subset(piccoli_comuni_male,
                                            TIME!=2020 & TIME!=2021 & TIME!=2022), 
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family = poisson(link = "identity"), 
                                corstr = "ar1")
summary(incomeSII_male_GEE_fit3)
```
\

Point estimate of the annual change of SII.

\
```{r}
incomeSII_male_GEE_piccoli_SAS3 <- read.csv("incomeSII_male_GEE_piccoli3.csv")
incomeSII_male_GEE_piccoli_vcov3 <- read.csv("incomeSII_male_GEE_piccoli_vcov3.csv")

incomeSII_male_GEE_piccoli_SAS3$Estimate[incomeSII_male_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"]
```
\

95\% confidence interval of the annual change of SII.

\
```{r}
c(incomeSII_male_GEE_piccoli_SAS3$Estimate[incomeSII_male_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"]-1.96*incomeSII_male_GEE_piccoli_SAS3$Stderr[incomeSII_male_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"],
  incomeSII_male_GEE_piccoli_SAS3$Estimate[incomeSII_male_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"]+1.96*incomeSII_male_GEE_piccoli_SAS3$Stderr[incomeSII_male_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"])
```
\

We now calculate the SII estimates of income rank in men obtained with the previous model.

\
```{r}
incomeSII_male_GEE_piccoli3 <- expand.grid(VAR="INCOME",SESSO=1,TIME=unique(male$TIME))
for(anno in unique(incomeSII_male_GEE_piccoli3$TIME)){
  #SII
  incomeSII_male_GEE_piccoli3$SII[incomeSII_male_GEE_piccoli3$TIME==anno] <- incomeSII_male_GEE_piccoli_SAS3$Estimate[12]+(anno-2011)*incomeSII_male_GEE_piccoli_SAS3$Estimate[13]
  #SE of SII
  incomeSII_male_GEE_piccoli3$SE[incomeSII_male_GEE_piccoli3$TIME==anno] <- sqrt(incomeSII_male_GEE_piccoli_vcov3[11,12]+(anno-2011)^2*incomeSII_male_GEE_piccoli_vcov3[12,13]+2*(anno-2011)*incomeSII_male_GEE_piccoli_vcov3[11,13])
}
incomeSII_male_GEE_piccoli3$lower95 <- incomeSII_male_GEE_piccoli3$SII-1.96*incomeSII_male_GEE_piccoli3$SE
incomeSII_male_GEE_piccoli3$upper95 <- incomeSII_male_GEE_piccoli3$SII+1.96*incomeSII_male_GEE_piccoli3$SE
```
\

### Women

#### Education

We implement models for the calculation of SII related to the educational rank in women, where the time variable is categorical.

\
```{r}
educSII_female_GEE_fit1 <- geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK):factor(TIME)-1,
                                  data=piccoli_comuni_female, 
                                  id = interaction(ITTER107,factor(AgeGroup)),
                                  family = poisson(link = "identity"),
                                  start = coef(educSII_female_fit1))
summary(educSII_female_GEE_fit1)
```
\

We load the model estimates obtained with the SAS software and proceed to calculate the SII estimates of the educational rank in women.

\
```{r}
educSII_female_GEE_piccoli_SAS <- read.csv("educSII_female_GEE_piccoli.csv")
educSII_female_GEE_piccoli_SAS <- educSII_female_GEE_piccoli_SAS[-1,]
educSII_female_GEE_piccoli <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(complete_df$TIME))
for(anno in unique(educSII_female_GEE_piccoli$TIME)){
  #SII
  educSII_female_GEE_piccoli$SII[educSII_female_GEE_piccoli$TIME==anno] <- educSII_female_GEE_piccoli_SAS$Estimate[educSII_female_GEE_piccoli_SAS$Level1==anno]
  #SE
  educSII_female_GEE_piccoli$SE[educSII_female_GEE_piccoli$TIME==anno] <- educSII_female_GEE_piccoli_SAS$Stderr[educSII_female_GEE_piccoli_SAS$Level1==anno]
  #lower95
  educSII_female_GEE_piccoli$lower95[educSII_female_GEE_piccoli$TIME==anno] <- educSII_female_GEE_piccoli_SAS$LowerCL[educSII_female_GEE_piccoli_SAS$Level1==anno]
  #upper95
  #SII
  educSII_female_GEE_piccoli$upper95[educSII_female_GEE_piccoli$TIME==anno] <- educSII_female_GEE_piccoli_SAS$UpperCL[educSII_female_GEE_piccoli_SAS$Level1==anno]
}
```
\

Now we implement a second model in which we consider the time variable as a continuous variable and consider the entire observation period.

\
```{r}
educSII_female_GEE_fit2 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                                 data=piccoli_comuni_female, 
                                 id = interaction(ITTER107,factor(AgeGroup)),
                                 family = poisson(link = "identity"), 
                                 corstr = "ar1")
summary(educSII_female_GEE_fit2)
```
\


Point estimate of the annual change of SII.

\
```{r}
educSII_female_GEE_piccoli_SAS2 <- read.csv("educSII_female_GEE_piccoli2.csv")
educSII_female_GEE_piccoli_vcov2 <- read.csv("educSII_female_GEE_piccoli_vcov2.csv")

educSII_female_GEE_piccoli_SAS2$Estimate[educSII_female_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]
```
\

95\% confidence interval of the annual change of SII

\
```{r}
c(educSII_female_GEE_piccoli_SAS2$Estimate[educSII_female_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]-1.96*educSII_female_GEE_piccoli_SAS2$Stderr[educSII_female_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"],
  educSII_female_GEE_piccoli_SAS2$Estimate[educSII_female_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]+1.96*educSII_female_GEE_piccoli_SAS2$Stderr[educSII_female_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"])
```
\

We now calculate the SII estimates of the educational rank in women obtained with the previous model.

\
```{r}
educSII_female_GEE_piccoli2 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educSII_female_GEE_piccoli2$TIME)){
  #SII
  educSII_female_GEE_piccoli2$SII[educSII_female_GEE_piccoli2$TIME==anno] <- educSII_female_GEE_piccoli_SAS2$Estimate[educSII_female_GEE_piccoli_SAS2$Parm=="pop_media*EDUC_RANK"]+(anno-2011)*educSII_female_GEE_piccoli_SAS2$Estimate[educSII_female_GEE_piccoli_SAS2$Parm=="pop_me*EDUC_RA*TIME1"]
  #SE of SII
  educSII_female_GEE_piccoli2$SE[educSII_female_GEE_piccoli2$TIME==anno] <- sqrt(educSII_female_GEE_piccoli_vcov2[11,12]+(anno-2011)^2*educSII_female_GEE_piccoli_vcov2[12,13]+2*(anno-2011)*educSII_female_GEE_piccoli_vcov2[11,13])
}
educSII_female_GEE_piccoli2$lower95 <- educSII_female_GEE_piccoli2$SII-1.96*educSII_female_GEE_piccoli2$SE
educSII_female_GEE_piccoli2$upper95 <- educSII_female_GEE_piccoli2$SII+1.96*educSII_female_GEE_piccoli2$SE
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
educSII_female_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*EDUC_RANK)+I(pop_media*EDUC_RANK):TIME1-1,
                              data=subset(piccoli_comuni_female,
                                          TIME!=2020 & TIME!= 2021 & TIME!=2022), 
                              id = interaction(ITTER107,factor(AgeGroup)),
                              family = poisson(link = "identity"), 
                              corstr = "ar1")
summary(educSII_female_GEE_fit3)
```
\

Point estimate of the annual change of SII.

\
```{r}
educSII_female_GEE_piccoli_SAS3 <- read.csv("educSII_female_GEE_piccoli3.csv")
educSII_female_GEE_piccoli_vcov3 <- read.csv("educSII_female_GEE_piccoli_vcov3.csv")

educSII_female_GEE_piccoli_SAS3$Estimate[educSII_female_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"]
```
\

95\% confidence interval of the annual change of SII.

\
```{r}
c(educSII_female_GEE_piccoli_SAS3$Estimate[educSII_female_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"]-1.96*educSII_female_GEE_piccoli_SAS3$Stderr[educSII_female_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"],
  educSII_female_GEE_piccoli_SAS3$Estimate[educSII_female_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"]+1.96*educSII_female_GEE_piccoli_SAS3$Stderr[educSII_female_GEE_piccoli_SAS3$Parm=="pop_me*EDUC_RA*TIME1"])
```
\

We now calculate the SII estimates of the eduactional rank in men obtained with the previous model.

\
```{r}
educSII_female_GEE_piccoli3 <- expand.grid(VAR="EDUC",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(educSII_female_GEE_piccoli3$TIME)){
  #SII
  educSII_female_GEE_piccoli3$SII[educSII_female_GEE_piccoli3$TIME==anno] <- educSII_female_GEE_piccoli_SAS3$Estimate[12]+(anno-2011)*educSII_female_GEE_piccoli_SAS3$Estimate[13]
  #SE of SII
  educSII_female_GEE_piccoli3$SE[educSII_female_GEE_piccoli3$TIME==anno] <- sqrt(educSII_female_GEE_piccoli_vcov3[11,12]+(anno-2011)^2*educSII_female_GEE_piccoli_vcov3[12,13]+2*(anno-2011)*educSII_female_GEE_piccoli_vcov3[11,13])
}
educSII_female_GEE_piccoli3$lower95 <- educSII_female_GEE_piccoli3$SII-1.96*educSII_female_GEE_piccoli3$SE
educSII_female_GEE_piccoli3$upper95 <- educSII_female_GEE_piccoli3$SII+1.96*educSII_female_GEE_piccoli3$SE
```
\

#### Income

At this point, the previous analyses are repeated for the estimation of the SII related to income rank in women over the observation period.

\
```{r}
incomeSII_female_GEE_fit1 <-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK):factor(TIME)-1,
                                   data=piccoli_comuni_female, 
                                   id = interaction(ITTER107,factor(AgeGroup)),
                                   family = poisson(link = "identity"), 
                                   corstr = "ar1")
summary(incomeSII_female_GEE_fit1)
```
\

SII estimates related to income rank in women.

\
```{r}
incomeSII_female_GEE_piccoli_SAS <- read.csv("incomeSII_female_GEE_piccoli.csv")
incomeSII_female_GEE_piccoli_SAS <- incomeSII_female_GEE_piccoli_SAS[-1,]
incomeSII_female_GEE_piccoli <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(complete_df$TIME))
for(anno in unique(incomeSII_female_GEE_piccoli$TIME)){
  #SII
  incomeSII_female_GEE_piccoli$SII[incomeSII_female_GEE_piccoli$TIME==anno] <- incomeSII_female_GEE_piccoli_SAS$Estimate[incomeSII_female_GEE_piccoli_SAS$Level1==anno]
  #SE
  incomeSII_female_GEE_piccoli$SE[incomeSII_female_GEE_piccoli$TIME==anno] <- incomeSII_female_GEE_piccoli_SAS$Stderr[incomeSII_female_GEE_piccoli_SAS$Level1==anno]
  #lower95
  incomeSII_female_GEE_piccoli$lower95[incomeSII_female_GEE_piccoli$TIME==anno] <- incomeSII_female_GEE_piccoli_SAS$LowerCL[incomeSII_female_GEE_piccoli_SAS$Level1==anno]
  #upper95
  #SII
  incomeSII_female_GEE_piccoli$upper95[incomeSII_female_GEE_piccoli$TIME==anno] <- incomeSII_female_GEE_piccoli_SAS$UpperCL[incomeSII_female_GEE_piccoli_SAS$Level1==anno]
}
```
\

Now we implement a second model in which we treat the time variable as a continuous variable and consider the whole observation period.

\
```{r}
incomeSII_female_GEE_fit2 <- geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                                    data=piccoli_comuni_female, 
                                    id = interaction(ITTER107,factor(AgeGroup)),
                                    family = poisson(link = "identity"), 
                                    corstr = "ar1")
summary(incomeSII_female_GEE_fit2)
```
\

Point estimate of the annual change of SII.

\
```{r}
incomeSII_female_GEE_piccoli_SAS2 <- read.csv("incomeSII_female_GEE_piccoli2.csv")
incomeSII_female_GEE_piccoli_vcov2 <- read.csv("incomeSII_female_GEE_piccoli_vcov2.csv")

incomeSII_female_GEE_piccoli_SAS2$Estimate[incomeSII_female_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"]
```
\

95\% confidence interval of the annual change of SII.

\
```{r}
c(incomeSII_female_GEE_piccoli_SAS2$Estimate[incomeSII_female_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"]-1.96*incomeSII_female_GEE_piccoli_SAS2$Stderr[incomeSII_female_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"],
  incomeSII_female_GEE_piccoli_SAS2$Estimate[incomeSII_female_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"]+1.96*incomeSII_female_GEE_piccoli_SAS2$Stderr[incomeSII_female_GEE_piccoli_SAS2$Parm=="pop_me*INCOME_*TIME1"])
```
\

We now calculate the SII estimates related to income rank in women obtained with the previous model.

\
```{r}
incomeSII_female_GEE_piccoli2 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeSII_female_GEE_piccoli2$TIME)){
  #SII
  incomeSII_female_GEE_piccoli2$SII[incomeSII_female_GEE_piccoli2$TIME==anno] <- incomeSII_female_GEE_piccoli_SAS2$Estimate[12]+(anno-2011)*incomeSII_female_GEE_piccoli_SAS2$Estimate[13]
  #SE of SII
  incomeSII_female_GEE_piccoli2$SE[incomeSII_female_GEE_piccoli2$TIME==anno] <- sqrt(incomeSII_female_GEE_piccoli_vcov2[11,12]+(anno-2011)^2*incomeSII_female_GEE_piccoli_vcov2[12,13]+2*(anno-2011)*incomeSII_female_GEE_piccoli_vcov2[11,13])
}
incomeSII_female_GEE_piccoli2$lower95 <- incomeSII_female_GEE_piccoli2$SII-1.96*incomeSII_female_GEE_piccoli2$SE
incomeSII_female_GEE_piccoli2$upper95 <- incomeSII_female_GEE_piccoli2$SII+1.96*incomeSII_female_GEE_piccoli2$SE
```
\

Next, we fit a new model in which we consider the time variable as a continuous variable in order to study the statistical significance of the interaction between time and income rank, excluding the calendar years 2020, 2021 and 2022.

\
```{r}
incomeSII_female_GEE_fit3<-geeglm(Decessi~pop_media:factor(AgeGroup)+I(pop_media*INCOME_RANK)+I(pop_media*INCOME_RANK):TIME1-1,
                                data=subset(piccoli_comuni_female,
                                            TIME!=2020 & TIME!=2021 & TIME!=2022), 
                                id = interaction(ITTER107,factor(AgeGroup)),
                                family = poisson(link = "identity"), 
                                corstr = "ar1")
summary(incomeSII_female_GEE_fit3)
```
\

Point estimate of the annual change of SII.
\
```{r}
incomeSII_female_GEE_piccoli_SAS3 <- read.csv("incomeSII_female_GEE_piccoli3.csv")
incomeSII_female_GEE_piccoli_vcov3 <- read.csv("incomeSII_female_GEE_piccoli_vcov3.csv")

incomeSII_female_GEE_piccoli_SAS3$Estimate[incomeSII_female_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"]
```
\

95\% confidence interval of the annual change of SII.

\
```{r}
c(incomeSII_female_GEE_piccoli_SAS3$Estimate[incomeSII_female_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"]-1.96*incomeSII_female_GEE_piccoli_SAS3$Stderr[incomeSII_female_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"],
  incomeSII_female_GEE_piccoli_SAS3$Estimate[incomeSII_female_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"]+1.96*incomeSII_female_GEE_piccoli_SAS3$Stderr[incomeSII_female_GEE_piccoli_SAS3$Parm=="pop_me*INCOME_*TIME1"])
```
\

We now calculate the SII estimates of income rank in women obtained with the previous model.

\
```{r}
incomeSII_female_GEE_piccoli3 <- expand.grid(VAR="INCOME",SESSO=2,TIME=unique(female$TIME))
for(anno in unique(incomeSII_female_GEE_piccoli3$TIME)){
  #SII
  incomeSII_female_GEE_piccoli3$SII[incomeSII_female_GEE_piccoli3$TIME==anno] <- incomeSII_female_GEE_piccoli_SAS3$Estimate[12]+(anno-2011)*incomeSII_female_GEE_piccoli_SAS3$Estimate[13]
  #SE of SII
  incomeSII_female_GEE_piccoli3$SE[incomeSII_female_GEE_piccoli3$TIME==anno] <- sqrt(incomeSII_female_GEE_piccoli_vcov3[11,12]+(anno-2011)^2*incomeSII_female_GEE_piccoli_vcov3[12,13]+2*(anno-2011)*incomeSII_female_GEE_piccoli_vcov3[11,13])
}
incomeSII_female_GEE_piccoli3$lower95 <- incomeSII_female_GEE_piccoli3$SII-1.96*incomeSII_female_GEE_piccoli3$SE
incomeSII_female_GEE_piccoli3$upper95 <- incomeSII_female_GEE_piccoli3$SII+1.96*incomeSII_female_GEE_piccoli3$SE
```
\

We create the dataset in which SII point and interval estimates of education rank and income rank, for both men and women, over the period between 2011 and 2022 obtained from the models in which time variable is considered as a categorical variable.
\
```{r}
SII_GEE_2011_2022_piccoli <- rbind(educSII_male_GEE_piccoli,educSII_female_GEE_piccoli,
                                   incomeSII_male_GEE_piccoli,incomeSII_female_GEE_piccoli)
SII_GEE_2011_2022_piccoli$SESSO <- factor(SII_GEE_2011_2022_piccoli$SESSO,
                                          levels = c(1,2),labels = c("Male","Female"))
SII_GEE_2011_2022_piccoli <- SII_GEE_2011_2022_piccoli[order(SII_GEE_2011_2022_piccoli$VAR,
                                                             SII_GEE_2011_2022_piccoli$SESSO,
                                                             SII_GEE_2011_2022_piccoli$TIME),]
save(SII_GEE_2011_2022_piccoli,file="SII_GEE_2011_2022_piccoli.Rdata")
```
\

We create an additional dataset in which SII point estimates of education rank and income rank for both men and women in the period between 2011 and 2022 obtained from the models, in which time variable is considered as a continuous variable, are saved.

\
```{r}
predSII_GEE_2011_2022_piccoli <- rbind(educSII_male_GEE_piccoli2,educSII_female_GEE_piccoli2,
                                       incomeSII_male_GEE_piccoli2,incomeSII_female_GEE_piccoli2)
predSII_GEE_2011_2022_piccoli$SESSO <- factor(predSII_GEE_2011_2022_piccoli$SESSO,
                                              levels = c(1,2),labels = c("Male","Female"))
predSII_GEE_2011_2022_piccoli <- predSII_GEE_2011_2022_piccoli[order(predSII_GEE_2011_2022_piccoli$VAR,
                                                                     predSII_GEE_2011_2022_piccoli$SESSO,
                                                                     predSII_GEE_2011_2022_piccoli$TIME),]
save(predSII_GEE_2011_2022_piccoli,file="predSII_GEE_2011_2022_piccoli.Rdata")
```
\

We create a third dataset in which SII point estimates of education rank and income rank, for both men and women, in the period between 2011 and 2022 obtained from the models in which time variable is considered as a continuous variable and in which the calendar years 2020, 2021 and 2022 are not considered.

\
```{r}
predSII_GEE_precovid_piccoli <- rbind(educSII_male_GEE_piccoli3,educSII_female_GEE_piccoli3,
                                          incomeSII_male_GEE_piccoli3,incomeSII_female_GEE_piccoli3)
predSII_GEE_precovid_piccoli$SESSO <- factor(predSII_GEE_precovid_piccoli$SESSO,
                                                 levels = c(1,2),labels = c("Male","Female"))
predSII_GEE_precovid_piccoli <- predSII_GEE_precovid_piccoli[order(predSII_GEE_precovid_piccoli$VAR,
                                                                           predSII_GEE_precovid_piccoli$SESSO,
                                                                           predSII_GEE_precovid_piccoli$TIME),]
save(predSII_GEE_precovid_piccoli,file="predSII_GEE_precovid_piccoli.Rdata")
```
\