---
title: "Results"
author: "Matteo Vergani"
date: "`r Sys.Date()`"
output: pdf_document
---

# LIBRARIES AND DIRECTORY 

The libraries required for analysis and the creation of the datasets needed for analysis are downloaded.

\
```{r message=FALSE, warning=FALSE}
# install.packages("stringr")   # If you haven't installed the package yet
library(dplyr) 
library(stringr)
library(readr)
library(labelled)   # labeling data
library(rstatix)    # summary statistics
library(ggpubr)     # convenient summary statistics and plots
library(GGally)     # advanced plot
library(car)        # useful for anova/wald test
library(Epi)        # easy getting CI for model coef/pred
library(lme4)       # linear mixed-effects models
library(lmerTest)   # test for linear mixed-effects models
library(emmeans)    # marginal means
library(multcomp)   # CI for linear combinations of model coef
library(geepack)    # generalized estimating equations
library(ggeffects)  # marginal effects, adjusted predictions
library(gt)         # nice tables
library(msm)        # delta method
library(glm2)
library(sf)
library(ggplot2)
library(ggthemes)
library(RColorBrewer)

library(tidyverse)  # for everything (data manipulation, visualization, coding, and more)
theme_set(theme_minimal() + theme(legend.position = "bottom")) # theme for ggplot
```
\

The directory is created, pointing to the address where the files containing the datasets are saved.

\
```{r}
directory <- "C:\\Users\\hp\\Documents\\UNIMIB\\Tesi\\Datasets\\"
setwd(directory)
```
\

# DATA

## Education and income data

The complete dataset containing all information on mortality, socio-economic variables and the population residing in Italian municipalities during the follow-up period is loaded.

\
```{r}
load("complete_df.Rdata")
complete_df$SESSO <- factor(complete_df$SESSO,levels = c(1,2),
                            labels = c("Male","Female"))
```
\

The education and income datasets are loaded in order to specifically consider data on educational attainment and income in the considered follow-up period in the Italian municipalities.

\
```{r}
load("istruzione.Rdata")
load("reddito.Rdata")
```
\

## Estimates of main analysis

In the following we upload the results for RII and SII obtained by implementing multiplicative and additive Poisson regression models considering data from all municipalities over the period 2011-2022 and using a GEE approach. The results allow us to compare the estimates of education rank and income rank and to compare female and male gender. Both the observed trend estimates over the reference period and the index predictions obtained considering the years between 2011 and 2019 are loaded.

\
```{r}
options(digits=5)
load("RII_GEE_2011_2022.Rdata") #RII
load("predRII_GEE_2011_2022.Rdata") #predizione RII in 2011-2022
load("predRII_GEE_precovid.Rdata") #predizione RII in 2011-2022 without considering 2020
load("SII_GEE_2011_2022.Rdata") #SII
load("predSII_GEE_2011_2022.Rdata") #predizione SII in 2011-2022
load("predSII_GEE_precovid.Rdata") #predizione SII in 2011-2022 without considering 2020
```
\

## Estimates of sensitivity analysis

In the following we upload the results for RII and SII obtained by implementing multiplicative and additive Poisson regression models considering data from the *small* municipalities over the period 2011-2022 and using a GEE approach. The results allow us to compare the estimates of education rank and income rank and to compare female and male gender. Both the observed trend estimates over the reference period and the index predictions obtained considering the years between 2011 and 2019 are loaded.

\
```{r}
options(digits=5)
load("RII_GEE_2011_2022_piccoli.Rdata") #RII
load("predRII_GEE_2011_2022_piccoli.Rdata") #predizione RII in 2011-2022
load("predRII_GEE_precovid_piccoli.Rdata") #predizione RII in 2011-2022 without considering 2020
load("SII_GEE_2011_2022_piccoli.Rdata") #SII
load("predSII_GEE_2011_2022_piccoli.Rdata") #predizione SII in 2011-2022
load("predSII_GEE_precovid_piccoli.Rdata") #predizione SII in 2011-2022 without considering 2020
```
\

# EXPLORATORY ANALYSIS

## Cartograms

We make charts with the municipalities represented with different colour intensities depending on the average income and the percentage of residents with low educational qualifications. To make such charts, we consider respectively the variables `Reddito imponibile medio` in the `reddito` dataset and `PERCENTAGE` in the `istruzione` dataset.

We make such charts considering the first and last year in which the data are available.


We load the file `Com01012023_WGS84.shp` which contains the geospatial data for the boundaries of the Italian municipalities as of 01/01/2023.

\
```{r}
italy_shape <- read_sf("Limiti01012023\\Com01012023\\Com01012023_WGS84.shp")
colnames(italy_shape)[colnames(italy_shape) == "PRO_COM_T"] <- "ITTER107"
```
\

### Percentage of residents with low educational attainment

We now merge the data on the level of education in Italian municipalities over the period 2011-2022 and the previously imported geospatial data.

\
```{r}
merged_istruz_data <- italy_shape %>%
  left_join(istruzione, by = "ITTER107")
```
\

We determine the value of the deciles of the `PERCENTAGE` variable in the year 2011 and create the auxiliary variable `EDUC_1` (categorical variable just on the deciles of `PERCENTAGE`) to represent the cartogram of the distribution of residents with low educational qualifications.

\
```{r}
istr_2011 <- subset(merged_istruz_data,TIME==2011)
round(quantile(istr_2011$PERCENTAGE*100, probs = seq(0, 1, 0.1), na.rm = TRUE),1)
```
\

The variable `EDUC_1` is created.

\
```{r}
istr_2011$EDUC_1 <- cut(istr_2011$PERCENTAGE,
                      breaks = c(quantile(istr_2011$PERCENTAGE, 
                                        probs = seq(0, 1, 0.1),
                                        na.rm = TRUE)),
                      labels = c("17.5% - 43.1%","43.1% - 46.1%",
                                 "46.1% - 48.4%", "48.4% - 50.2%",
                                 "50.2% - 51.9%", "51.9% - 53.5%",
                                 "53.5% - 55.3%", "55.3% - 57.5%",
                                 "57.5% - 60.7%", "60.7% - 85.3%"),
                      include.lowest = TRUE)
```
\

We now produce a cartogram of Italian municipalities depicted in different colours according to the percentage of residents over the age of 25 with a low educational qualification (i.e. less than high school education) in 2011.

\
```{r}
ggplot(istr_2011) +
  geom_sf(aes(fill = EDUC_1), color = NA) + 
  scale_fill_manual(values = rev(brewer.pal(10, "RdYlGn")),
                    name = "Percentage") +
  labs(title = "% residenti con basso titolo di studio per Comune nel 2011") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
  #guides(fill = guide_legend(ncol = 2, nrow = 5)) 
ggsave("istruzione_2011.jpeg")
```
\

Similar to what was done for the year 2011, we now create the cartogram of Italian municipalities represented in different colours according to the percentage of residents with a low educational qualification (below high school level) in 2022.


We determine the value of the deciles of the variable `PERCENTAGE` in the year 2011 and create the auxiliary variable `EDUC_1` (categorial variable and just the deciles of `PERCENTAGE`) to represent the cartogram of the distribution of residents with low educational qualifications.

\
```{r}
istr_2022 <- subset(merged_istruz_data,TIME==2022)
round(quantile(istr_2022$PERCENTAGE*100, probs = seq(0, 1, 0.1), na.rm = TRUE),1)
```
\

The variable `EDUC_1` is created.

\
```{r}
istr_2022$EDUC_1 <- cut(istr_2022$PERCENTAGE,
                      breaks = c(quantile(istr_2022$PERCENTAGE, 
                                        probs = seq(0, 1, 0.1),
                                        na.rm = TRUE)),
                      labels = c("14.8% - 33.4%","33.4% - 36.3%",
                                 "36.3% - 38.4%", "38.4% - 40.1%",
                                 "40.1% - 41.8%", "41.8% - 43.4%",
                                 "43.4% - 45.4%", "45.4% - 47.7%",
                                 "47.7% - 51.3%", "51.3% - 79.2%"),
                      include.lowest = TRUE)
```
\

We now produce a cartogram of Italian municipalities depicted in different colours according to the percentage of residents over the age of 25 with a low educational qualification (i.e. less than high school education) in 2022.

\
```{r}
ggplot(istr_2022) +
  geom_sf(aes(fill = EDUC_1), color = NA) + 
  scale_fill_manual(values = rev(brewer.pal(10, "RdYlGn")),
                    name = "Percentage") +
  labs(title = "% residenti con basso titolo di studio per Comune nel 2022") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
  #guides(fill = guide_legend(ncol = 2, nrow = 5)) 
ggsave("istruzione_2022.jpeg")
```
\

### Average taxable income

A datset is created in which geospatial data and income data in the Italian municipalities in the considered follow-up period are merged.

\
```{r}
merged_reddito_data <- italy_shape %>%
  left_join(reddito, by = "ITTER107")
```
\

The main descriptive statistics of the variable `Reddito imponibile medio` in each year of the study period are calculated to assess the differences over time.

\
```{r}
reddito[!is.na(reddito$`Reddito imponibile medio`),] %>%
  group_by(TIME) %>%
  summarise(Min = min(`Reddito imponibile medio`),
            Q1 = quantile(`Reddito imponibile medio`,0.25),
            Median = median(`Reddito imponibile medio`),
            Q3 = quantile(`Reddito imponibile medio`,0.75),
            Max = max(`Reddito imponibile medio`),
            Mean = mean(`Reddito imponibile medio`),
            StdDev = sd(`Reddito imponibile medio`),
            .groups = "drop")
```
\

We determine the deciles of the variable `Reddito imponibile medio` for the year 2011, in order to define the labels of the variable `INCOME` and then make the corresponding cartogram.

\
```{r}
income_2011 <- subset(merged_reddito_data,TIME==2011)
round(quantile(income_2011$`Reddito imponibile medio`,probs=seq(0,1,0.1),na.rm=T))
```
\

We define the auxiliary variable `INCOME_1` that will be used to produce the cartogram.

\
```{r}
income_2011$INCOME_1 <- cut(income_2011$`Reddito imponibile medio`,
                            breaks = c(quantile(income_2011$`Reddito imponibile medio`, 
                                                probs = seq(0, 1, 0.1),
                                                na.rm = TRUE)),
                            labels = c("6.491 - 11.532", "11.532 - 12.836", "12.836 - 14.139",
                                       "14.139 - 15.319", "15.319 - 16.287", "16.287 - 17.180",
                                       "17.180 - 18.086", "18.086 - 19.050", "19.050 -20.463",
                                       "20.463 - 44.271"),
                            include.lowest = TRUE)
```
\

We now produce a cartogram of Italian municipalities depicted in different colours according to the income level in 2011.

\
```{r}
Euro <- "\u20AC"
ggplot(income_2011[!is.na(income_2011$INCOME_1),]) +
  geom_sf(aes(fill = INCOME_1), color = NA) + 
  scale_fill_manual(values = brewer.pal(10, "RdYlGn"),
                    name = paste0("Average income per capita (",Euro,")")) +
  labs(title = "Reddito imponibile medio per Comune nel 2011") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
#guides(fill = guide_legend(ncol = 2, nrow = 5)) 
ggsave("income_2011.jpeg")
```
\

I perform the previous steps in a similar manner in order to produce the cartogram for the year 2022.


I determine the deciles of the variable `Reddito imponibile medio` for the year 2022, in order to define the labels of the variable `INCOME` and then make the corresponding cartogram.

\
```{r}
income_2022 <- subset(merged_reddito_data,TIME==2022)
round(quantile(income_2022$`Reddito imponibile medio`,probs=seq(0,1,0.1),na.rm=T))
```
\

Definisco la variabile ausiliaria `INCOME_1` che servirà per realizzare il cartogramma


\
```{r}
income_2022$INCOME_1 <- cut(income_2022$`Reddito imponibile medio`,
                            breaks = c(quantile(income_2022$`Reddito imponibile medio`, 
                                                probs = seq(0, 1, 0.1),
                                                na.rm = TRUE)),
                            labels = c("6.805 - 13.357", "13.357 - 14.676", "14.676 - 16.014",
                                       "16.014 - 17.366", "17.366 - 18.420", "18.420 - 19.437",
                                       "19.437 - 20.423", "20.423 - 21.429", "21.429 -22.833",
                                       "22.833 - 52.378"),
                            include.lowest = TRUE)
```
\

We now produce a cartogram of Italian municipalities depicted in different colours according to the income level in 2022.

\
```{r}
ggplot(income_2022[!is.na(income_2022$INCOME_1),]) +
  geom_sf(aes(fill = INCOME_1), color = NA) + 
  scale_fill_manual(values = brewer.pal(10, "RdYlGn"),
                    name = paste0("Average income per capita (",Euro,")")) +
  labs(title = "Reddito imponibile medio per Comune nel 2022") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
  #guides(fill = guide_legend(ncol = 2, nrow = 5)) 
ggsave("income_2022.jpeg")
```
\

## Tables

A number of age groups are aggregated together in a similar way to what was done for the implementation of the RII and SII models.

\
```{r}
complete_df_new <- complete_df  %>% 
  mutate(AgeGroup = case_when(
    CL_ETA %in% c(1,2,3,4,5) ~ 1,
    CL_ETA %in% c(6,7,8,9,10) ~ 2,
    CL_ETA %in% 11 ~ 3,
    CL_ETA %in% 12 ~ 4,
    CL_ETA %in% 13 ~ 5,
    CL_ETA %in% 14 ~ 6,
    CL_ETA %in% 15 ~ 7,
    CL_ETA %in% 16 ~ 8,
    CL_ETA %in% 17 ~ 9,
    CL_ETA %in% 18 ~ 10))
complete_df_new <- complete_df_new %>%
  group_by(ITTER107, Territorio, TIME, SESSO, AgeGroup, INCOME, INCOME_RANK, EDUC, EDUC_RANK) %>%
  summarise(
    Decessi = sum(Decessi),
    pop_media = sum(pop_media),
    .groups = "drop"
  )
```
\

### Income

We create a table in which we can display the number of deaths, crude mortality rates and standardised mortality rates per year and group of municipalities defined by each income level.

We calculate the mortality rate per year and group of municipalities defined by income level.

\
```{r}
tassi_reddito_eta <- complete_df_new %>%
  group_by(SESSO,INCOME,AgeGroup,TIME) %>%
  summarise(Decessi_tot = sum(Decessi),
            pop_tot = sum(pop_media),
            .groups = "drop")
tassi_reddito_eta$Tasso <- tassi_reddito_eta$Decessi_tot/tassi_reddito_eta$pop_tot
```
\

Now consider WHO World Standard Population Distribution (%), based on world average population between 2000-2025, we will use them as weights to standardise for age structure the rates of each municipality group defined by income level, gender and year.

\
```{r}
weights <- c(8.83+8.69+8.60+8.47+8.22,7.93+7.61+7.15+6.59+6.04,
             5.37,4.55,3.72,2.96,2.21,1.52,0.91,0.63)/100
sum(weights)
```
\

Now let's standardise the male rates.

\
```{r}
tassi_male <- subset(tassi_reddito_eta,SESSO=="Male")
smr_male <- tassi_male %>%
  distinct(SESSO,INCOME,TIME)
smr_male$Tasso_std <- 0
for (anno in unique(tassi_male$TIME)) {
  for (income in unique(tassi_male$INCOME)) {
    temp <- subset(tassi_male,TIME==anno & INCOME==income)
    smr_male$Tasso_std[smr_male$TIME==anno & smr_male$INCOME==income] <- sum(temp$Tasso*weights)
  }
}
```
\

Now let's standardise the female rates.

\
```{r}
tassi_female <- subset(tassi_reddito_eta,SESSO=="Female")
smr_female <- tassi_female %>%
  distinct(SESSO,INCOME,TIME)
smr_female$Tasso_std <- 0
for (anno in unique(tassi_female$TIME)) {
  for (income in unique(tassi_female$INCOME)) {
    temp <- subset(tassi_female,TIME==anno & INCOME==income)
    smr_female$Tasso_std[smr_female$TIME==anno & smr_female$INCOME==income] <- sum(temp$Tasso*weights)
  }
}
```
\

I merge the two previous datasets into one.

\
```{r}
tassi_std_reddito <- rbind(smr_male,smr_female)
```
\

Now we calculate the crude mortality rates per year and group of municipalities defined by income level.

\
```{r}
tasso_grezzo_reddito <- complete_df_new %>%
  group_by(SESSO,INCOME,TIME) %>%
  summarise(Decessi = sum(Decessi),
            Popolazione = sum(pop_media),
            .groups = "drop")
tasso_grezzo_reddito$Tasso_grezzo <- tasso_grezzo_reddito$Decessi/tasso_grezzo_reddito$Popolazione
```
\

Merge between raw and standardised rates. 

\
```{r}
tassi <- merge(tasso_grezzo_reddito,tassi_std_reddito)
tassi <- tassi[,c("SESSO","INCOME","TIME","Decessi","Popolazione","Tasso_grezzo","Tasso_std")]
```
\

For the male gender, a table is constructed in which the number of deaths per year and group of municipalities defined by income level can be displayed.
\
```{r}
table_male_rates <- subset(tassi,SESSO=="Male")
table_male_rates$Tasso_std <- table_male_rates$Tasso_std*100000
table_male_rates <- table_male_rates[order(table_male_rates$TIME,table_male_rates$INCOME),]
xtabs(Decessi ~ TIME + INCOME, data = table_male_rates)
```
\

We construct a table in which we can display the standardised rate (per 10000 person-years) per year and group of municipalities defined by income level.

\
```{r}
round(xtabs(Tasso_std ~ TIME + INCOME, data = table_male_rates),2)
```
\

For the female gender, a table is constructed in which the number of deaths per year and group of municipalities defined by income level can be displayed.

\
```{r}
table_female_rates <- subset(tassi,SESSO=="Female")
table_female_rates$Tasso_std <- table_female_rates$Tasso_std*100000
table_female_rates <- table_female_rates[order(table_female_rates$TIME,table_female_rates$INCOME),]
xtabs(Decessi ~ TIME + INCOME, data = table_female_rates)
```
\

Now we construct a table in which we can display the standardised rate (per 10000 person-years) by year and group of municipalities defined by income level.


\
```{r}
round(xtabs(Tasso_std ~ TIME + INCOME, data = table_female_rates),2)
```
\

Now we construct a graph in which we can display the standardised rate (per 10000 person-years) per year and group of municipalities defined by income level, among men and women.


\
```{r}
ggplot(tassi, 
       aes(x = factor(TIME), y = Tasso_std*100000, 
           color = INCOME,
           group = interaction(INCOME, SESSO))) +
  geom_line() +
  geom_point() +
  facet_grid(. ~ SESSO) + #,labeller = label_both
  labs(x = "Year", y = "ASMR (per 10000 p-y)",
       title = "Age-standardised all-causes mortality rates",
       fill="INCOME") +
  scale_y_continuous(breaks = seq(200,600,by=50),limits = c(200,600)) +
  scale_color_manual(values = brewer.pal(10, "RdYlGn"),name="INCOME") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),  # Adjust axis text size
        axis.title = element_text(size = 14),  # Adjust axis label size
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14),  # Adjust legend title size
        strip.text = element_text(size = 14),  # Adjust facet label size
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))
ggsave("income_asmr.jpeg")
```
\

### Education

We want to create a table in which we can display the number of deaths, crude mortality rates and standardised mortality rates per year and group of municipalities defined by each educational grade level.


We calculate the mortality rate per year and group of municipalities defined by the educational grade level.

\
```{r}
tassi_istruzione_eta <- complete_df_new %>%
  group_by(SESSO,EDUC,AgeGroup,TIME) %>%
  summarise(Decessi_tot = sum(Decessi),
            pop_tot = sum(pop_media),
            .groups = "drop")
tassi_istruzione_eta$Tasso <- tassi_istruzione_eta$Decessi_tot/tassi_istruzione_eta$pop_tot
```
\

We now standardise male rates.

\
```{r}
tassi_istruzione_male <- subset(tassi_istruzione_eta,SESSO=="Male")
smr_istruzione_male <- tassi_istruzione_male %>%
  distinct(SESSO,EDUC,TIME)
smr_istruzione_male$Tasso_std <- 0
for (anno in unique(tassi_istruzione_male$TIME)) {
  for (istr in unique(tassi_istruzione_male$EDUC)) {
    temp <- subset(tassi_istruzione_male,TIME==anno & EDUC==istr)
    smr_istruzione_male$Tasso_std[smr_istruzione_male$TIME==anno & smr_istruzione_male$EDUC==istr] <- sum(temp$Tasso*weights)
  }
}
```
\

We now standardise female rates.

\
```{r}
tassi_istruzione_female <- subset(tassi_istruzione_eta,SESSO=="Female")
smr_istruzione_female <- tassi_istruzione_female %>%
  distinct(SESSO,EDUC,TIME)
smr_istruzione_female$Tasso_std <- 0
for (anno in unique(smr_istruzione_female$TIME)) {
  for (istr in unique(smr_istruzione_female$EDUC)) {
    temp <- subset(tassi_istruzione_female,TIME==anno & EDUC==istr)
    smr_istruzione_female$Tasso_std[smr_istruzione_female$TIME==anno & smr_istruzione_female$EDUC==istr] <- sum(temp$Tasso*weights)
  }
}
```
\

we merge the two previous datasets.

\
```{r}
tassi_std_istruzione <- rbind(smr_istruzione_male,smr_istruzione_female)
```
\

Now we calculate the crude mortality rates per year and defined group of municipalities of the eduactional level.

\
```{r}
tasso_grezzo_istruzione <- complete_df_new %>%
  group_by(SESSO,EDUC,TIME) %>%
  summarise(Decessi = sum(Decessi),
            Popolazione = sum(pop_media),
            .groups = "drop")
tasso_grezzo_istruzione$Tasso_grezzo <- tasso_grezzo_istruzione$Decessi/tasso_grezzo_istruzione$Popolazione
```
\

Merge between raw and standardised rates. 

\
```{r}
tassi_istruzione <- merge(tasso_grezzo_istruzione,tassi_std_istruzione)
tassi_istruzione <- tassi_istruzione[,c("SESSO","EDUC","TIME","Decessi","Popolazione","Tasso_grezzo","Tasso_std")]
```
\

For the male gender, we construct a table in which we can display the number of deaths per year and group of municipalities defined by educational level.

\
```{r}
table_male_educ_rates <- subset(tassi_istruzione,SESSO=="Male")
table_male_educ_rates$Tasso_std <- table_male_educ_rates$Tasso_std*100000
table_male_educ_rates <- table_male_educ_rates[order(table_male_educ_rates$TIME,table_male_educ_rates$EDUC),]
xtabs(Decessi ~ TIME + EDUC, data = table_male_educ_rates)
```
\

We construct a table in which we can display the standardised rate (per 10000 person-years) per year and group of municipalities defined by educational level.  

\
```{r}
round(xtabs(Tasso_std ~ TIME + EDUC, data = table_male_educ_rates),2)
```
\

Similar tables to the previous ones are now created for the female gender.

\
```{r}
table_female_educ_rates <- subset(tassi_istruzione,SESSO=="Female")
table_female_educ_rates$Tasso_std <- table_female_educ_rates$Tasso_std*100000
table_female_educ_rates <- table_female_educ_rates[order(table_female_educ_rates$TIME,table_female_educ_rates$EDUC),]
xtabs(Decessi ~ TIME + EDUC, data = table_female_educ_rates)
```
\

We construct a table in which we can display the standardised rate (per 10000 person-years) per year and group of municipalities defined by educational level. 

\
```{r}
round(xtabs(Tasso_std ~ TIME + EDUC, data = table_female_educ_rates),2)
```
\

Now we construct a graph in which we can display the standardised rate (per 10000 person-years) per year and group of municipalities defined by educational level, among men and women.

\
```{r}
ggplot(tassi_istruzione, 
       aes(x = factor(TIME), y = Tasso_std*100000, 
           color = EDUC,
           group = interaction(EDUC, SESSO))) +
  geom_line() +
  geom_point() +
  facet_grid(. ~ SESSO) + #,labeller = label_both
  labs(x = "Year", y = "ASMR (per 10000 p-y)",
       title = "Age-standardised all-causes mortality rates",
       fill = "EDUC") +
  scale_y_continuous(breaks = seq(200,600,by=50),limits = c(200,600)) +
  scale_color_manual(values = rev(brewer.pal(10, "RdYlGn")),name="EDUC") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),  # Adjust axis text size
        axis.title = element_text(size = 14),  # Adjust axis label size
        legend.text = element_text(size = 14),  # Adjust legend text size
        legend.title = element_text(size = 14),  # Adjust legend title size
        plot.title = element_text(hjust=0.5, size = 14, face = "bold"),  # Adjust plot title size
        strip.text = element_text(size = 14))  # Adjust facet label size
ggsave("educ_asmr.jpeg")
```
\

### Correlation

Correlation between `INCOME_RANK` and `EDUC_RANK` over time.

\
```{r}
complete_df %>%
  group_by(TIME) %>%
  summarise(correlation = round(cor(EDUC_RANK, INCOME_RANK),2))
```
\

## MAIN ANALYSIS

### RII

We create the tables in which we present the point estimates of the RII for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(RII ~ TIME + VAR + SESSO,data = RII_GEE_2011_2022),2)
```
\

We create tables in which we present the estimates of the lower bound of the 95\% CI for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(lower95 ~ TIME + VAR + SESSO,data = RII_GEE_2011_2022),2)
```
\

We create tables in which we present the estimates of the upper bound of the 95\% CI for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(upper95 ~ TIME + VAR + SESSO,data = RII_GEE_2011_2022),2)
```
\

We now visualise in a graph the data of the RII estimates by year and socioeconomic rank in men. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted RII with 2011-2022 data are presented.

\
```{r}
plot_rii <- ggplot(subset(RII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)"), col = "red") +
  geom_point(col = "red") +  
  geom_errorbar(aes(ymin = lower95, ymax = upper95), 
                width = 0.2, col = "red") +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII",
       title = "RII estimates and 95% CI") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        strip.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold")) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_2011_2022, SESSO=="Male"), 
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)"),
            col = "darkgreen") +
  geom_ribbon(data = subset(predRII_GEE_2011_2022, SESSO=="Male"),
              aes(ymin = lower95, ymax = upper95), alpha = 0.2,fill="lightgreen") +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid",
                                   "Model 2 (Prediction 2011-2022)" = "dashed")) +
  guides(linetype = guide_legend(title = "Estimate", 
                                 override.aes = list(color = c("red", "darkgreen")))) 
ggsave("rii_male.jpeg")
```
\

We now visualise in a graph the data of the RII estimates by year and socioeconomic rank in women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted RII with 2011-2022 data are presented.

\
```{r}
plot_rii <- ggplot(subset(RII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)"), col = "red") +
  geom_point(col = "red") +  
  geom_errorbar(aes(ymin = lower95, ymax = upper95), 
                width = 0.2, col = "red") +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") + #title = "RII estimates and 95% CI in women"
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_2011_2022, SESSO=="Female"), 
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)"),
            col = "darkgreen") +
  geom_ribbon(data = subset(predRII_GEE_2011_2022, SESSO=="Female"),
              aes(ymin = lower95, ymax = upper95), alpha = 0.2,fill="lightgreen") +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid", 
                                   "Model 2 (Prediction 2011-2022)" = "dashed")) +
  guides(linetype = guide_legend(title = "Estimate", 
                                 override.aes = list(color = c("red", "darkgreen")))) 
ggsave("rii_female.jpeg")
```
\

Comparison of linear trends obtained from model 2 (2011-2022 data) vs model 3 (pre-pandemic data), considering men.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Model 2 (2011-2022)",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),
                  fill="Model 2 (2011-2022)"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_precovid, SESSO=="Male"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Model 3 (pre COVID-19)"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_precovid, SESSO=="Male"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Model 3 (pre COVID-19)"),
              alpha = 0.2) +
  scale_color_manual(values = c("Model 2 (2011-2022)" = "darkblue", "Model 3 (pre COVID-19)" = "#FF7F00"),
                     breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                     name="Prediction") +
  scale_fill_manual(values = c("Model 2 (2011-2022)" = "darkblue", "Model 3 (pre COVID-19)" = "#FF7F00"),
                    breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                    name="Prediction")
ggsave("confronto_pred_rii_male.jpeg")
```
\

Comparison of linear trends obtained from model 2 (2011-2022 data) vs model 3 (pre-pandemic data), considering women.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Model 2 (2011-2022)",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),fill="Model 2 (2011-2022)"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_precovid, SESSO=="Female"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Model 3 (pre COVID-19)"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_precovid, SESSO=="Female"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Model 3 (pre COVID-19)"),
              alpha = 0.2) +
  scale_color_manual(values = c("Model 2 (2011-2022)" = "darkblue", "Model 3 (pre COVID-19)" = "#FF7F00"),
                     breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                     name="Prediction") +
  scale_fill_manual(values = c("Model 2 (2011-2022)" = "darkblue", "Model 3 (pre COVID-19)" = "#FF7F00"),
                    breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                    name="Prediction")
ggsave("confronto_pred_rii_female.jpeg")
```
\

We now produce the graph of the RII estimates by year and socioeconomic rank, among both men and women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted RII with 2011-2022 data are presented.

\
```{r}
plot <- ggplot(RII_GEE_2011_2022,
       aes(x = factor(TIME), y = RII, 
           color = VAR,group = interaction(VAR, SESSO))) +
  geom_line(position=position_dodge(width = 0.3),
            aes(color=VAR, linetype = "Tempo categoriale")) +
  geom_point(position=position_dodge(width = 0.3),
             aes(color=VAR)) +  # Add points for RII estimates
  geom_errorbar(aes(ymin = lower95, ymax = upper95,color=VAR), 
                width = 0.2,position=position_dodge(width = 0.3)) +
  labs(x = "Anno", y = "RII",
       title = "Stime del RII e IC al 95%") +
  facet_grid(. ~ SESSO,labeller = labeller(SESSO = c(Male = "Uomini", Female = "Donne"))) +
  scale_y_continuous(breaks = seq(0.85,1.35,0.05),limits = c(0.85,1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  scale_color_manual(values = c("EDUC" = "darkblue", "INCOME" = "#FF7F00"),name="") +
  scale_x_discrete(labels = c("Male" = "Uomini", "Female" = "Donne"))+
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        strip.text = element_text(size = 12),
        #legend.position = c(0.5,0.15),
        legend.position = "bottom",
        legend.box = "horizontal")

dat_text <- data.frame(
  label = c("0,97% (0,78%; 1,16%)","0,40% (0,23%; 0,58%)",
            "1,24% (0,97%; 1,50%)","0,59% (0,31%; 0,86%)"),
  VAR = c("EDUC","INCOME","EDUC","INCOME"),
  SESSO   = c("Male", "Male","Female","Female"),
  x     = rep(8,4),
  y     = c(0.875,0.925,0.875,0.925))

plot +
  geom_line(data = predRII_GEE_2011_2022, 
            aes(x = factor(TIME), y = RII,color=VAR,
                group = interaction(VAR, SESSO),
                linetype = "Tempo continuo")) +
  geom_ribbon(data = predRII_GEE_2011_2022,
              aes(ymin = lower95, ymax = upper95,fill = VAR),
              color=NA, alpha = 0.2) +
  #annotate("text", x = 3, y = 0.925, label = "APC (95% CI)", 
  #         size = 4, color = "black",fontface = "bold") +
  geom_label(label="APC (95% IC)", x=2.75, y=0.9,label.size = 0.2, 
             color = "white", fill="black",fontface="bold") +
  geom_label(data = dat_text, 
             mapping = aes(x = x, y = y, label = label, fill=interaction(VAR)),
             fontface = "bold",show.legend = F,colour = "white") +
  scale_linetype_manual(values = c("Tempo categoriale" = "solid",
                                   "Tempo continuo" = "dashed"),
                        name="") +
  scale_fill_manual(values = c("EDUC" = "darkblue", "INCOME" = "#FF7F00"),name="")
ggsave("rii_presentation.jpeg")
```
\

### SII

We create tables in which we present the IBS estimates (per 100000 person-years) for the rank of education in the follow-up period, one for each gender.

\
```{r}
round(xtabs(SII*1e5 ~ VAR + TIME + SESSO,data = SII_GEE_2011_2022),2)
```
\

We create tables in which we present the estimates of the lower bound of the 95\% CI for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(lower95*1e5 ~ VAR + TIME + SESSO,data = SII_GEE_2011_2022),2)
```
\

We create tables in which we present the estimates of the upper bound of the 95\% CI for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(upper95*1e5 ~ VAR + TIME + SESSO,data = SII_GEE_2011_2022),2)
```
\

We now visualise in a graph the data of the SII estimates (per 100000 person-years) by year and socioeconomic rank in men. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted SII with 2011-2022 data are presented.

\
```{r}
plot_sii <- ggplot(subset(SII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)",
                col = "Model 1 (Time categorical)")) +
  geom_point(col="red") +  
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5),
                col="red",width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") + 
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_2011_2022, SESSO=="Male"), 
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)",
                col = "Model 2 (Prediction 2011-2022)")) +
  geom_ribbon(data = subset(predSII_GEE_2011_2022, SESSO=="Male"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO)),
              fill="lightgreen",
              alpha = 0.2) +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid", 
                                   "Model 2 (Prediction 2011-2022)" = "dashed"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate") +
  scale_color_manual(values = c("Model 1 (Time categorical)" = "red", 
                                   "Model 2 (Prediction 2011-2022)" = "darkgreen"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate")
ggsave("sii_male.jpeg")
```

We now visualise in a graph the data of the SII estimates (per 100000 person-years) by year and socioeconomic rank in women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted SII with 2011-2022 data are presented.

\
```{r}
plot_sii <- ggplot(subset(SII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)",
                col = "Model 1 (Time categorical)")) +
  geom_point(col="red") +  
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5),
                col="red",width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") + 
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_2011_2022, SESSO=="Female"), 
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)",
                col = "Model 2 (Prediction 2011-2022)")) +
  geom_ribbon(data = subset(predSII_GEE_2011_2022, SESSO=="Female"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO)),
              fill="lightgreen",
              alpha = 0.2) +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid", 
                                   "Model 2 (Prediction 2011-2022)" = "dashed"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate") +
  scale_color_manual(values = c("Model 1 (Time categorical)" = "red", 
                                   "Model 2 (Prediction 2011-2022)" = "darkgreen"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate")
ggsave("sii_female.jpeg")
```
\

Comparison of linear trends of SII obtained from model 2 (2011-2022 data) vs model 3 (pre-pandemic data), considering men.

\
```{r}
plot_sii <- ggplot(subset(predSII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Model 2 (2011-2022)",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO),fill="Model 2 (2011-2022)"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_precovid, SESSO=="Male"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Model 3 (pre COVID-19)"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predSII_GEE_precovid, SESSO=="Male"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5, 
                  group = interaction(VAR, SESSO),
                  fill="Model 3 (pre COVID-19)"),
              alpha = 0.2) +
  scale_color_manual(values = c("Model 2 (2011-2022)" = "darkblue", 
                                "Model 3 (pre COVID-19)" = "#FF7F00"),
                     breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                     name="Prediction") +
  scale_fill_manual(values = c("Model 2 (2011-2022)" = "darkblue", 
                               "Model 3 (pre COVID-19)" = "#FF7F00"),
                    breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                    name="Prediction")
ggsave("confronto_pred_sii_male.jpeg")
```
\

Comparison of linear trends of SII obtained from model 2 (2011-2022 data) vs model 3 (pre-pandemic data), considering women.

\
```{r}
plot_sii <- ggplot(subset(predSII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Model 2 (2011-2022)",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO),fill="Model 2 (2011-2022)"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_precovid, SESSO=="Female"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Model 3 (pre COVID-19)"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predSII_GEE_precovid, SESSO=="Female"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5, 
                  group = interaction(VAR, SESSO),
                  fill="Model 3 (pre COVID-19)"),
              alpha = 0.2) +
  scale_color_manual(values = c("Model 2 (2011-2022)" = "darkblue", 
                                "Model 3 (pre COVID-19)" = "#FF7F00"),
                     breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                     name="Prediction") +
  scale_fill_manual(values = c("Model 2 (2011-2022)" = "darkblue", 
                               "Model 3 (pre COVID-19)" = "#FF7F00"),
                    breaks = c("Model 2 (2011-2022)","Model 3 (pre COVID-19)"),
                    name="Prediction")
ggsave("confronto_pred_sii_female.jpeg")
```
\

We now produce the graph of the SII estimates (per 100000 person-years) by year and socioeconomic rank, among both men and women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted SII with 2011-2022 data are presented.

\
```{r}
plot <- ggplot(SII_GEE_2011_2022,
       aes(x = factor(TIME), y = SII*1e5, 
           color = VAR,group = interaction(VAR, SESSO))) +
  geom_line(position=position_dodge(width = 0.3),
            aes(color=VAR, linetype = "Tempo categoriale")) +
  geom_point(position=position_dodge(width = 0.3),
             aes(color=VAR)) +  # Add points for RII estimates
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5,color=VAR), 
                width = 0.2,position=position_dodge(width = 0.3)) +
  labs(x = "Anno", y = "SII (per 100.000 p-y)",
       title = "Stime del SII e IC al 95%") +
  facet_grid(. ~ SESSO,labeller = labeller(SESSO = c(Male = "Uomini", Female = "Donne"))) +
  scale_y_continuous(breaks = seq(-10,70,10), limits = c(-10,70)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  scale_color_manual(values = c("EDUC" = "darkblue", "INCOME" = "#FF7F00"),name="") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        strip.text = element_text(size = 12),
        legend.position = "bottom",
        legend.box = "horizontal")

dat_text <- data.frame(
  label = c("-2,46 (-2,73; -2,20)","-2,21 (-2,44; -1,99)",
            "-1,04 (-1,24; -0,85)","-1,03 (-1,20; -0,86)"),
  VAR = c("EDUC","INCOME","EDUC","INCOME"),
  SESSO   = c("Male", "Male","Female","Female"),
  x     = rep(8,4),
  y     = c(55,65,55,65))

ac_text <- data.frame(
  label = c("AC (95% IC)","AC (95% IC)"),
  VAR = c("EDUC","INCOME"),
  SESSO   = c("Male","Female"),
  x     = rep(3,2),
  y     = c(60,60))


plot +
  geom_line(data = predSII_GEE_2011_2022, 
            aes(x = factor(TIME), y = SII*1e5,color=VAR,
                group = interaction(VAR, SESSO),
                linetype = "Tempo continuo")) +
  geom_ribbon(data = predSII_GEE_2011_2022,
              aes(ymin = lower95*1e5, ymax = upper95*1e5,fill = VAR),
              color=NA, alpha = 0.2) +
  geom_label(data = ac_text, mapping = aes(x=x, y=y,label = label), 
             color = "white", fill="black",fontface="bold",show.legend = F) +
  geom_label(data = dat_text, 
             mapping = aes(x = x, y = y, label = label, fill=interaction(VAR)),
             fontface = "bold",show.legend = F,colour = "white") +
  scale_fill_manual(values = c("EDUC" = "darkblue", "INCOME" = "#FF7F00"),name="") +
  scale_linetype_manual(values = c("Tempo categoriale" = "solid",
                                   "Tempo continuo" = "dashed"),
                        name = "")
ggsave("sii_presentation.jpeg")
```
\

## SENSITIVITY ANALYSIS

### RII

We create the tables in which we present the point estimates of the RII for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(RII ~ TIME + VAR + SESSO,data = RII_GEE_2011_2022_piccoli),2)
```
\

We create tables in which we present the estimates of the lower bound of the 95\% CI for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(lower95 ~ TIME + VAR + SESSO,data = RII_GEE_2011_2022_piccoli),2)
```
\

We create tables in which we present the estimates of the upper bound of the 95\% CI for education rank and male gender in the follow-up period between 2011 and 2022, one for each gender.

\
```{r}
round(xtabs(upper95 ~ TIME + VAR + SESSO,data = RII_GEE_2011_2022_piccoli),2)
```
\

We now visualise in a graph the data of the RII estimates by year and socioeconomic rank in men. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted RII with 2011-2022 data are presented.

\
```{r}
plot_rii <- ggplot(subset(RII_GEE_2011_2022_piccoli, SESSO == "Male"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)"), col = "red") +
  geom_point(col = "red") +  
  geom_errorbar(aes(ymin = lower95, ymax = upper95), 
                width = 0.2, col = "red") +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Male"), 
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)"),
            col = "darkgreen") +
  geom_ribbon(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Male"),
              aes(ymin = lower95, ymax = upper95), 
              alpha = 0.2,fill="lightgreen") +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid",
                                   "Model 2 (Prediction 2011-2022)" = "dashed")) +
  guides(linetype = guide_legend(title = "Estimate", 
                                 override.aes = list(color = c("red", "darkgreen")))) 
ggsave("rii_male_piccoli.jpeg")
```
\

We now visualise in a graph the data of the RII estimates by year and socioeconomic rank in women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted RII with 2011-2022 data are presented.

\
```{r}
plot_rii <- ggplot(subset(RII_GEE_2011_2022_piccoli, SESSO == "Female"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)"), col = "red") +
  geom_point(col = "red") +  
  geom_errorbar(aes(ymin = lower95, ymax = upper95), 
                width = 0.2, col = "red") +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") + #title = "RII estimates and 95% CI in women"
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Female"), 
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)"),
            col = "darkgreen") +
  geom_ribbon(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Female"),
              aes(ymin = lower95, ymax = upper95), alpha = 0.2,fill="lightgreen") +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid", 
                                   "Model 2 (Prediction 2011-2022)" = "dashed")) +
  guides(linetype = guide_legend(title = "Estimate", 
                                 override.aes = list(color = c("red", "darkgreen")))) 
ggsave("rii_female_piccoli.jpeg")
```
\

Comparison of linear trends obtained from model 2 (2011-2022 data) vs model 3 (pre-pandemic data), considering men.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_2011_2022_piccoli, SESSO == "Male"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Model 2 (2011-2022)",group = interaction(VAR, SESSO)),
            linetype = "dashed") +
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),
                  fill="Model 2 (2011-2022)"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Male"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Model 3 (pre COVID-19)"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Male"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Model 3 (pre COVID-19)"),
              alpha = 0.2) +
  scale_color_manual(values = c("Model 2 (2011-2022)" = "darkblue",
                                "Model 3 (pre COVID-19)" = "#FF7F00"),
                     breaks = c("Model 2 (2011-2022)",
                                "Model 3 (pre COVID-19)"),
                     name="Prediction") +
  scale_fill_manual(values = c("Model 2 (2011-2022)" = "darkblue", 
                               "Model 3 (pre COVID-19)" = "#FF7F00"),
                    breaks = c("Model 2 (2011-2022)",
                               "Model 3 (pre COVID-19)"),
                    name="Prediction")
ggsave("confronto_pred_rii_male_piccoli.jpeg")
```
\

Comparison of linear trends obtained from model 2 (2011-2022 data) vs model 3 (pre-pandemic data), considering women.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_2011_2022_piccoli, SESSO == "Female"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Model 2 (2011-2022)",
                group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),
                  fill="Model 2 (2011-2022)"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Female"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Model 3 (pre COVID-19)"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Female"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Model 3 (pre COVID-19)"),
              alpha = 0.2) +
  scale_color_manual(values = c("Model 2 (2011-2022)" = "darkblue", 
                                "Model 3 (pre COVID-19)" = "#FF7F00"),
                     breaks = c("Model 2 (2011-2022)",
                                "Model 3 (pre COVID-19)"),
                     name="Prediction") +
  scale_fill_manual(values = c("Model 2 (2011-2022)" = "darkblue",
                               "Model 3 (pre COVID-19)" = "#FF7F00"),
                    breaks = c("Model 2 (2011-2022)",
                               "Model 3 (pre COVID-19)"),
                    name="Prediction")
ggsave("confronto_pred_rii_female_piccoli.jpeg")
```
\

Comparison of linear trends obtained from model 1 of main analysis and sensitivity analysis respectively, considering women.

\
```{r}
plot_rii <- ggplot(subset(RII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col = "Main analysis",
                group = interaction(VAR, SESSO))) +
  geom_point(aes(col = "Main analysis",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(aes(ymin = lower95, ymax = upper95,
                    group = interaction(VAR, SESSO),
                    col = "Main analysis"), 
                width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(RII_GEE_2011_2022_piccoli, SESSO=="Female"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis")) +
  geom_point(data = subset(RII_GEE_2011_2022_piccoli, SESSO=="Female"),
             aes(col = "Sensitivity analysis",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(data = subset(RII_GEE_2011_2022_piccoli, SESSO=="Female"),
                aes(ymin = lower95, ymax = upper95,
                    group = interaction(VAR, SESSO),
                    col = "Sensitivity analysis"), 
                width = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue", "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis")
ggsave("rii_female_confronto_analisi.jpeg")
```
\

Comparison of linear trends obtained from model 1 of main analysis and sensitivity analysis respectively, considering men.

\
```{r}
plot_rii <- ggplot(subset(RII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col = "Main analysis",
                group = interaction(VAR, SESSO))) +
  geom_point(aes(col = "Main analysis",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(aes(ymin = lower95, ymax = upper95,
                    group = interaction(VAR, SESSO),
                    col = "Main analysis"), 
                width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(RII_GEE_2011_2022_piccoli, SESSO=="Male"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis")) +
  geom_point(data = subset(RII_GEE_2011_2022_piccoli, SESSO=="Male"),
             aes(col = "Sensitivity analysis",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(data = subset(RII_GEE_2011_2022_piccoli, SESSO=="Male"),
                aes(ymin = lower95, ymax = upper95,
                    group = interaction(VAR, SESSO),
                    col = "Sensitivity analysis"), 
                width = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue", "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis")
ggsave("rii_male_confronto_analisi.jpeg")
```
\

Comparison of linear trends obtained from model 2 of main analysis and sensitivity analysis respectively, considering women.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Female"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Female"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred2_rii_analisi_female.jpeg")
```
\

Comparison of linear trends obtained from model 2 of main analysis and sensitivity analysis respectively, considering men.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Male"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_2011_2022_piccoli, SESSO=="Male"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred2_rii_analisi_male.jpeg")
```
\

Comparison of linear trends obtained from model 3 of main analysis and sensitivity analysis respectively, considering women.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_precovid, SESSO == "Female"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Female"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Female"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred3_rii_analisi_female.jpeg")
```
\

Comparison of linear trends obtained from model 3 of main analysis and sensitivity analysis respectively, considering men.

\
```{r}
plot_rii <- ggplot(subset(predRII_GEE_precovid, SESSO == "Male"), 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95, ymax = upper95,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "RII") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.05), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Male"),
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predRII_GEE_precovid_piccoli, SESSO=="Male"),
              aes(ymin = lower95, ymax = upper95, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred3_rii_analisi_male.jpeg")
```
\

We now produce the graph of the RII estimates by year and socioeconomic rank, among both men and women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared.

\
```{r}
plot_rii <- ggplot(RII_GEE_2011_2022, 
                   aes(x = factor(TIME), y = RII,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col = "Analisi principale",
                group = interaction(VAR, SESSO))) +
  geom_point(aes(col = "Analisi principale",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(aes(ymin = lower95, ymax = upper95,
                    group = interaction(VAR, SESSO),
                    col = "Analisi principale"), 
                width = 0.2) +
  facet_grid(VAR~SESSO,labeller = labeller(SESSO = c(Female = "Donne",Male = "Uomini"))) +
  labs(x = "Anno", y = "RII",
       title = "RII - Analisi principale vs Analisi di sensibilità") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(0.85, 1.35, 0.1), limits = c(0.85, 1.35)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = RII_GEE_2011_2022_piccoli,
            aes(x = factor(TIME), y = RII,
                group = interaction(VAR, SESSO),
                col="Analisi di sensibilità")) +
  geom_point(data = RII_GEE_2011_2022_piccoli,
             aes(col = "Analisi di sensibilità",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(data = RII_GEE_2011_2022_piccoli,
                aes(ymin = lower95, ymax = upper95,
                    group = interaction(VAR, SESSO),
                    col = "Analisi di sensibilità"), 
                width = 0.2) +
  scale_color_manual(values = c("Analisi principale" = "darkblue", "Analisi di sensibilità" = "#FF7F00"),
                     breaks = c("Analisi principale","Analisi di sensibilità"),
                     name="")
ggsave("rii_confronto_analisi.jpeg")
```



### SII

We create tables of SII estimates (per 100000 person-years) for the rank of education in the follow-up period, one for each gender.

\
```{r}
round(xtabs(SII*1e5 ~ TIME + VAR + SESSO,data = SII_GEE_2011_2022_piccoli),2)
```
\

We create tables of the estimates of the lower bound (per 100000 person-years) of the 95\% CI of the SII related to the rank of education in the follow-up period, one for each gender.

\
```{r}
round(xtabs(lower95*1e5 ~ TIME + VAR + SESSO,data = SII_GEE_2011_2022_piccoli),2)
```
\

We create tables of the estimates of the upper bound (per 100000 person-years) of the 95\% CI of the SII related to the rank of education in the follow-up period, one for each gender.

\
```{r}
round(xtabs(upper95*1e5 ~ TIME + VAR + SESSO,data = SII_GEE_2011_2022_piccoli),2)
```
\

We now visualise in a graph the data of the SII estimates (per 100000 person-years) by year and socioeconomic rank in men. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted SII with 2011-2022 data are presented.

\
```{r}
plot_sii <- ggplot(subset(SII_GEE_2011_2022_piccoli, SESSO == "Male"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)",
                col = "Model 1 (Time categorical)")) +
  geom_point(col="red") +  
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5),
                col="red",width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") + 
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Male"), 
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)",
                col = "Model 2 (Prediction 2011-2022)")) +
  geom_ribbon(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Male"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO)),
              fill="lightgreen",
              alpha = 0.2) +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid", 
                                   "Model 2 (Prediction 2011-2022)" = "dashed"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate") +
  scale_color_manual(values = c("Model 1 (Time categorical)" = "red", 
                                   "Model 2 (Prediction 2011-2022)" = "darkgreen"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate")
ggsave("sii_male_piccoli.jpeg")
```
\

We now visualise in a graph the data of the SII estimates (per 100000 person-years) by year and socioeconomic rank in women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared. Estimates of the linear trend of the predicted SII with 2011-2022 data are presented.

\
```{r}
plot_sii <- ggplot(subset(SII_GEE_2011_2022_piccoli, SESSO == "Female"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(linetype = "Model 1 (Time categorical)",
                col = "Model 1 (Time categorical)")) +
  geom_point(col="red") +  
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5),
                col="red",width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") + 
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "purple") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Female"), 
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                linetype = "Model 2 (Prediction 2011-2022)",
                col = "Model 2 (Prediction 2011-2022)")) +
  geom_ribbon(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Female"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO)),
              fill="lightgreen",
              alpha = 0.2) +
  scale_linetype_manual(values = c("Model 1 (Time categorical)" = "solid", 
                                   "Model 2 (Prediction 2011-2022)" = "dashed"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate") +
  scale_color_manual(values = c("Model 1 (Time categorical)" = "red", 
                                   "Model 2 (Prediction 2011-2022)" = "darkgreen"),
                        breaks = c("Model 1 (Time categorical)",
                                   "Model 2 (Prediction 2011-2022)"),
                        name = "Estimate")
ggsave("sii_female_piccoli.jpeg")
```
\

Comparison of linear trends of SII obtained from model 1 in main analysis and sensitivity analysis respectively, considering women.

\
```{r}
plot_sii <- ggplot(subset(SII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col = "Main analysis",
                group = interaction(VAR, SESSO))) +
  geom_point(aes(col = "Main analysis",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                    group = interaction(VAR, SESSO),
                    col = "Main analysis"), 
                width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(SII_GEE_2011_2022_piccoli, SESSO=="Female"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis")) +
  geom_point(data = subset(SII_GEE_2011_2022_piccoli, SESSO=="Female"),
             aes(x = factor(TIME), y = SII*1e5,
                 group = interaction(VAR, SESSO),
                 col="Sensitivity analysis")) +  
  geom_errorbar(data = subset(SII_GEE_2011_2022_piccoli, SESSO=="Female"),
                aes(ymin = lower95*1e5, ymax=upper95*1e5,
                    group = interaction(VAR, SESSO),
                    col="Sensitivity analysis"), 
                width = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("sii_female_confronto_analisi.jpeg")
```
\

Comparison of linear trends of SII obtained from model 1 in main analysis and sensitivity analysis respectively, considering men.

\
```{r}
plot_sii <- ggplot(subset(SII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col = "Main analysis",
                group = interaction(VAR, SESSO))) +
  geom_point(aes(col = "Main analysis",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                    group = interaction(VAR, SESSO),
                    col = "Main analysis"), 
                width = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(SII_GEE_2011_2022_piccoli, SESSO=="Male"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis")) +
  geom_point(data = subset(SII_GEE_2011_2022_piccoli, SESSO=="Male"),
             aes(x = factor(TIME), y = SII*1e5,
                 group = interaction(VAR, SESSO),
                 col="Sensitivity analysis")) +  
  geom_errorbar(data = subset(SII_GEE_2011_2022_piccoli, SESSO=="Male"),
                aes(ymin = lower95*1e5, ymax=upper95*1e5,
                    group = interaction(VAR, SESSO),
                    col="Sensitivity analysis"), 
                width = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("sii_male_confronto_analisi.jpeg")
```
\

Comparison of linear trends of SII obtained from model 2 in main analysis and sensitivity analysis respectively, considering women.

\
```{r}
plot_sii <- ggplot(subset(predSII_GEE_2011_2022, SESSO == "Female"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-10,70,10), limits = c(-10,70)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Female"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Female"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred2_sii_analisi_female.jpeg")
```
\

Comparison of linear trends of SII obtained from model 2 in main analysis and sensitivity analysis respectively, considering men.

\
```{r}
plot_sii <- ggplot(subset(predSII_GEE_2011_2022, SESSO == "Male"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Male"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predSII_GEE_2011_2022_piccoli, SESSO=="Male"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred2_sii_analisi_male.jpeg")
```
\

Comparison of linear trends of SII obtained from model 3 in main analysis and sensitivity analysis respectively, considering men.

\
```{r}
plot_sii <- ggplot(subset(predSII_GEE_precovid, SESSO == "Female"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = subset(predSII_GEE_precovid_piccoli, SESSO=="Female"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predSII_GEE_precovid_piccoli, SESSO=="Female"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred3_sii_analisi_female.jpeg")
```
\

Comparison of linear trends of SII obtained from model 3 in main analysis and sensitivity analysis respectively, considering women.

\
```{r}
plot_rii <- ggplot(subset(predSII_GEE_precovid, SESSO == "Male"), 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col="Main analysis",group = interaction(VAR, SESSO)),
            linetype = "dashed")+
  geom_ribbon(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                  group = interaction(VAR, SESSO),
                  fill="Main analysis"),
              alpha = 0.2) +
  facet_grid(. ~ VAR) +
  labs(x = "Year", y = "SII (per 100,000 p-y)") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-15,65,10), limits = c(-15,65)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(size = 12),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_rii +
  geom_line(data = subset(predSII_GEE_precovid_piccoli, SESSO=="Male"),
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Sensitivity analysis"),
            linetype = "dashed") +
  geom_ribbon(data = subset(predSII_GEE_precovid_piccoli, SESSO=="Male"),
              aes(ymin = lower95*1e5, ymax = upper95*1e5, 
                  group = interaction(VAR, SESSO),
                  fill="Sensitivity analysis"),
              alpha = 0.2) +
  scale_color_manual(values = c("Main analysis" = "darkblue",
                                "Sensitivity analysis" = "#FF7F00"),
                     breaks = c("Main analysis","Sensitivity analysis"),
                     name="Analysis") +
  scale_fill_manual(values = c("Main analysis" = "darkblue",
                               "Sensitivity analysis" = "#FF7F00"),
                    breaks = c("Main analysis","Sensitivity analysis"),
                    name="Analysis")
ggsave("confronto_pred3_sii_analisi_male.jpeg")
```
\

We now produce the graph of the SII estimates (per 100000 person-years) by year and socioeconomic rank, among both men and women. The observed estimates and the point and interval predictions produced by the model considering the entire observation period between 2011 and 2022 are compared.

\
```{r}
plot_sii <- ggplot(SII_GEE_2011_2022, 
                   aes(x = factor(TIME), y = SII*1e5,
                       group = interaction(VAR, SESSO))) +
  geom_line(aes(col = "Analisi principale",
                group = interaction(VAR, SESSO))) +
  geom_point(aes(col = "Analisi principale",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(aes(ymin = lower95*1e5, ymax = upper95*1e5,
                    group = interaction(VAR, SESSO),
                    col = "Analisi principale"), 
                width = 0.2) +
  facet_grid(VAR~SESSO,labeller = labeller(SESSO = c(Female = "Donne",Male = "Uomini"))) +
  labs(x = "Anno", y = "SII (per 100.000 p-y)",
       title = "SII - Analisi principale vs Analisi di sensibilità") +
  theme_minimal() +
  scale_y_continuous(breaks = seq(-20,80,20), limits = c(-20,80)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "chartreuse3") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        strip.text = element_text(size = 12)) +
  theme(legend.position = "bottom")

plot_sii +
  geom_line(data = SII_GEE_2011_2022_piccoli,
            aes(x = factor(TIME), y = SII*1e5,
                group = interaction(VAR, SESSO),
                col="Analisi di sensibilità")) +
  geom_point(data = SII_GEE_2011_2022_piccoli,
             aes(x = factor(TIME), y = SII*1e5,
                 col = "Analisi di sensibilità",
                 group = interaction(VAR, SESSO))) +  
  geom_errorbar(data = SII_GEE_2011_2022_piccoli,
                aes(ymin = lower95*1e5, ymax = upper95*1e5,
                    group = interaction(VAR, SESSO),
                    col = "Analisi di sensibilità"), 
                width = 0.2) +
  scale_color_manual(values = c("Analisi principale" = "darkblue", "Analisi di sensibilità" = "#FF7F00"),
                     breaks = c("Analisi principale","Analisi di sensibilità"),
                     name="")
ggsave("sii_confronto_analisi.jpeg")
```
\


